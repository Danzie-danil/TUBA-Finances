<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="tuba-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="tuba-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="tuba-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="tuba-icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="tuba-icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>TUBA</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        .privacy-blur {
            filter: blur(8px);
            -webkit-filter: blur(8px);
            transition: filter 0.3s ease;
        }

        .privacy-toggle-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4), inset 0 -1px 2px rgba(0, 0, 0, 0.2);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .privacy-toggle-btn.show {
            display: flex;
        }

        .privacy-toggle-btn:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6), inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }

        .privacy-toggle-btn:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        .privacy-container {
            position: relative;
            margin-bottom: 12px;
        }

        input[readonly] {
            background: rgba(0, 0, 0, 0.05);
            cursor: not-allowed;
            color: #666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            padding-bottom: 70px;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(145deg, #1a1a1a, #000000);
            color: white;
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 15px;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .header-btn {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.6), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        .header-btn:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 0 2px 10px rgba(46, 125, 50, 0.4), inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .header-btn-left {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #1976d2, #0d47a1);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        .header-btn-left:hover {
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.6), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        .header-btn-left:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 0 2px 10px rgba(25, 118, 210, 0.4), inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .content {
            padding: 16px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: linear-gradient(145deg, #1a1a1a, #000000);
            color: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .stat-subvalue {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12),
                0 1px 3px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
        }

        .card:hover {
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .card h2 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .card-header-buttons {
            position: absolute;
            right: 14px;
            top: 14px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .quick-nav-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.18), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .quick-nav-btn:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .quick-nav-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .quick-nav-btn.products {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }

        .quick-nav-btn.categories {
            background: linear-gradient(145deg, #e65100, #bf360c);
        }

        .quick-nav-btn.back {
            background: linear-gradient(145deg, #1976d2, #0d47a1);
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button,
        .btn {
            width: 100%;
            padding: 11px;
            background: linear-gradient(145deg, #1a1a1a, #000000);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            box-shadow: 0 5px 16px rgba(0, 0, 0, 0.28), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #757575, #424242);
        }

        .btn-success {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }

        .btn-danger {
            background: linear-gradient(145deg, #d32f2f, #b71c1c);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 13px;
            width: auto;
        }

        .item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.07),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .item:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-title {
            font-weight: 700;
            font-size: 15px;
            color: #1a1a1a;
        }

        .item-subtitle {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .badge-success {
            background: linear-gradient(145deg, #66bb6a, #43a047);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(145deg, #ffeb3b, #fbc02d);
            color: #333;
        }

        .badge-danger {
            background: linear-gradient(145deg, #ef5350, #c62828);
            color: white;
        }

        .badge-paid {
            background: linear-gradient(145deg, #66bb6a, #43a047);
            color: white;
        }

        .badge-unpaid {
            background: linear-gradient(145deg, #ef5350, #c62828);
            color: white;
        }

        .badge-mpesa {
            background: linear-gradient(145deg, #ef5350, #c62828);
            color: white;
        }

        .badge-crdb {
            background: linear-gradient(145deg, #66bb6a, #43a047);
            color: white;
        }

        .badge-nmb {
            background: linear-gradient(145deg, #ff9800, #e65100);
            color: white;
        }

        .badge-yas {
            background: linear-gradient(145deg, #42a5f5, #1976d2);
            color: white;
        }

        .badge-airtel {
            background: linear-gradient(145deg, #d32f2f, #b71c1c);
            color: white;
        }

        .badge-halopesa {
            background: linear-gradient(145deg, #ffeb3b, #fbc02d);
            color: #333;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            overflow-x: auto;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            min-width: 70px;
            max-width: 90px;
            padding: 10px 4px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #666;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            word-wrap: break-word;
            overflow: hidden;
        }

        .nav-item span:last-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .nav-item.active {
            background: linear-gradient(145deg, #1a1a1a, #000000);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .nav-item:hover:not(.active) {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
        }

        .nav-icon {
            font-size: 20px;
        }

        .info-box {
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
            padding: 12px;
            border-radius: 12px;
            margin-top: 12px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .flex-gap {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 16px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 28px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .toast {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            bottom: 75px;
        }

        .toast-success {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
        }

        .toast-error {
            background: linear-gradient(145deg, #d32f2f, #b71c1c);
        }

        .toast-info {
            background: linear-gradient(145deg, #1976d2, #0d47a1);
        }

        .transaction-tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .transaction-tab {
            padding: 14px 16px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab:active {
            transform: translateY(0);
        }

        .transaction-tab.mpesa {
            background: linear-gradient(145deg, #d32f2f, #b71c1c);
            opacity: 0.6;
        }

        .transaction-tab.mpesa.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(211, 47, 47, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.crdb {
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
            opacity: 0.6;
        }

        .transaction-tab.crdb.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.nmb {
            background: linear-gradient(145deg, #e65100, #bf360c);
            opacity: 0.6;
        }

        .transaction-tab.nmb.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(230, 81, 0, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.yas {
            background: linear-gradient(145deg, #0d47a1, #01579b);
            opacity: 0.6;
        }

        .transaction-tab.yas.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(13, 71, 161, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.halopesa {
            background: linear-gradient(145deg, #fdd835, #f9a825);
            color: #000;
            opacity: 0.6;
        }

        .transaction-tab.halopesa.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(253, 216, 53, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .transaction-tab.airtel {
            background: linear-gradient(145deg, #b71c1c, #7f0000);
            opacity: 0.6;
        }

        .transaction-tab.airtel.active {
            opacity: 1;
            box-shadow: 0 8px 25px rgba(183, 28, 28, 0.4), inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .note-preview {
            cursor: pointer;
            max-height: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            line-height: 1.5;
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .note-preview:hover {
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border-color: rgba(102, 126, 234, 0.4);
        }

        .note-preview:active {
            transform: translateY(-2px) scale(1.01);
        }

        .collapse-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(145deg, #f8f8f8, #e8e8e8);
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            color: #555;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin: 12px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .collapse-btn:hover {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .collapse-btn:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .collapse-icon {
            font-size: 12px;
            transition: transform 0.3s;
        }

        .collapse-icon.expanded {
            transform: rotate(180deg);
        }

        .highlight-pulse {
            animation: highlightFade 1s ease-out;
        }

        @keyframes highlightFade {
            0% {
                background: rgba(102, 126, 234, 0.3);
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
            }

            100% {
                background: transparent;
                box-shadow: none;
            }
        }

        .search-box {
            margin-bottom: 16px;
        }

        .search-box input {
            background: white;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-row input,
        .filter-row select {
            flex: 1;
            min-width: 120px;
        }

        .filter-row input[type="date"] {
            position: relative;
        }

        .filter-row input[type="date"]::-webkit-datetime-edit {
            display: block;
            padding: 0;
        }

        .filter-row input[type="date"]::-webkit-datetime-edit-fields-wrapper {
            display: block;
        }

        .filter-row input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 8px;
            cursor: pointer;
        }

        .alert-box {
            background: linear-gradient(145deg, #fff3e0, #ffe0b2);
            border-left: 4px solid #e65100;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(230, 81, 0, 0.2);
        }

        .alert-box-danger {
            background: linear-gradient(145deg, #ffebee, #ffcdd2);
            border-left: 4px solid #d32f2f;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.2);
        }

        .alert-success {
            background: linear-gradient(145deg, #e8f5e9, #c8e6c9);
            border-left: 4px solid #2e7d32;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
        }

        .alert-info {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #1976d2;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.2);
        }

        .alert-info {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #1976d2;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.2);
        }

        .float-balance-container {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.2);
            border: 2px solid rgba(25, 118, 210, 0.3);
        }

        .float-balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(25, 118, 210, 0.2);
        }

        .float-balance-row:last-child {
            border-bottom: none;
        }

        .float-balance-label {
            font-weight: 600;
            color: #0d47a1;
            font-size: 14px;
        }

        .float-balance-value {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 16px;
        }

        .float-balance-value.positive {
            color: #2e7d32;
        }

        .float-balance-value.negative {
            color: #d32f2f;
        }

        .editable-float {
            padding: 8px 12px;
            border: 2px solid rgba(25, 118, 210, 0.3);
            border-radius: 8px;
            background: white;
            font-weight: 700;
            color: #1976d2;
            cursor: pointer;
            display: inline-block;
            min-width: 100px;
            text-align: right;
        }

        .editable-float:hover {
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #2e7d32, #66bb6a);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeOut 0.5s ease-in-out 1.5s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .welcome-logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .welcome-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-subtitle {
            color: #aaa;
            font-size: 14px;
            animation: slideUp 0.8s ease-out 0.2s both;
        }

        .app-container {
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out 2s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }

        .quick-stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 640px) {
            .stat-grid {
                grid-template-columns: 1fr;
            }

            .transaction-tabs {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-row {
                flex-direction: column;
            }

            .filter-row input,
            .filter-row select {
                width: 100%;
            }
        }

        .sync-indicator {
            position: absolute;
            left: 62px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 13px;
            background: linear-gradient(145deg, #2e7d32, #1b5e20);
            color: white;
            display: none;
            white-space: nowrap;
        }

        .sync-indicator.show {
            display: block;
        }

        .sync-indicator.syncing {
            background: linear-gradient(145deg, #1976d2, #0d47a1);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

        }

        .checkbox-select {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
            accent-color: #1976d2;
        }

        .bulk-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: linear-gradient(145deg, #f5f5f5, #e8e8e8);
            border-radius: 12px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .bulk-actions label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            margin: 0;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
    <!-- Add this line -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Your existing scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div class="welcome-screen">
        <div class="welcome-logo">💼</div>
        <div class="welcome-title">TUBA</div>
        <div class="welcome-subtitle">The Ultimate Business Architecture</div>
    </div>

    <div class="app-container">
        <div class="header">
            <button class="header-btn-left" onclick="importData()">📥</button>
            <div class="sync-indicator" id="syncIndicator">☁️ Synced</div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                <h1 style="margin: 0;">💼 TUBA</h1>
                <div id="headerDate" style="font-size: 9px; opacity: 0.8; font-weight: 400;"></div>
            </div>
            <button class="header-btn" onclick="exportData()">💾</button>
        </div>

        <div class="content" id="app"></div>
        <div class="bottom-nav" id="bottomNav"></div>
    </div>

    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-title">Note Details</div>
            <div id="noteModalContent"></div>
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn-small" onclick="editNoteFromModal()">Edit</button>
                <button class="btn-small btn-danger" onclick="deleteNoteFromModal()">Delete</button>
                <button class="btn-small btn-secondary" onclick="closeNoteModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="floatModal">
        <div class="modal-content">
            <div class="modal-title">Set Initial Float</div>
            <div id="floatModalContent"></div>
        </div>
    </div>

    <script>
        // ========================================
        // SUPABASE CONFIGURATION
        // ========================================
        const SUPABASE_URL = 'https://mjxklwonzrpawerfopdj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qeGtsd29uenJwYXdlcmZvcGRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjY0MzYsImV4cCI6MjA3NjA0MjQzNn0.cWLOALsj1iwxgFsSlWMTcMwf4Zfm8pIY5z1ICNNcsdk';

        let supabase;
        let currentUser = null;
        let syncEnabled = false;

        // Your existing code continues below...
        const SHOP_NAME = "";
        const SHOP_ADDRESS = "";
        const SHOP_PHONE = "";
        const SHOP_EMAIL = "";

        // ========================================
        // SUPABASE FUNCTIONS
        // ========================================

        function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true,
                        storageKey: 'tuba-auth-token',
                        storage: window.localStorage
                    }
                });

                console.log('✅ Supabase initialized');

                // Listen for auth state changes
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth event:', event);

                    if (event === 'SIGNED_IN' && session) {
                        currentUser = session.user;
                        syncEnabled = true;
                        updateSyncIndicator('synced');

                        // Don't call render here - it's handled in signIn()
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        syncEnabled = false;
                        updateSyncIndicator('offline');
                        render();
                    } else if (event === 'TOKEN_REFRESHED' && session) {
                        console.log('✅ Token refreshed');
                        currentUser = session.user;
                        syncEnabled = true;
                    }
                });

            } catch (error) {
                console.error('Supabase init error:', error);
                syncEnabled = false;
            }
        }

        async function restoreSession() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    console.error('Session restore error:', error);
                    return false;
                }

                if (session) {
                    currentUser = session.user;
                    syncEnabled = true;
                    updateSyncIndicator('synced');

                    // Load user profile
                    await loadUserProfile();

                    // Load data from cloud
                    await pullDataFromSupabase();

                    console.log('✅ Session restored successfully');
                    return true;
                }

                return false;
            } catch (error) {
                console.error('Restore session error:', error);
                return false;
            }
        }

        async function loadUserProfile() {
            if (!syncEnabled || !currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading profile:', error);
                    return;
                }

                if (data) {
                    state.userProfile = {
                        businessName: data.business_name || "",
                        email: data.email || currentUser.email || "",
                        phone: data.phone || "",
                        address: data.address || ""
                    };
                    state.profileEditMode = false;
                    state.profileLoaded = true; // Mark as loaded
                    saveData();
                } else {
                    // New user - show edit mode ONCE
                    state.profileEditMode = true;
                    state.profileLoaded = false;
                }
            } catch (error) {
                console.error('Load profile error:', error);
            }
        }

        async function createDefaultProfile() {
            if (!syncEnabled || !currentUser) return;

            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .insert({
                        user_id: currentUser.id,
                        business_name: state.userProfile.businessName,
                        email: currentUser.email,
                        phone: state.userProfile.phone,
                        address: state.userProfile.address
                    });

                if (error) {
                    console.error('Error creating profile:', error);
                }
            } catch (error) {
                console.error('Create profile error:', error);
            }
        }

        async function saveUserProfile(profileData) {
            if (!syncEnabled || !currentUser) {
                showToast('Please sign in to save profile', 'error');
                return false;
            }

            try {
                updateSyncIndicator('syncing');

                const { error } = await supabase
                    .from('user_profiles')
                    .upsert({
                        user_id: currentUser.id,
                        business_name: profileData.businessName,
                        email: profileData.email,
                        phone: profileData.phone,
                        address: profileData.address,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });


                if (error) throw error;

                state.userProfile = { ...profileData };
                saveData();
                updateSyncIndicator('synced');

                // Mark profile as loaded after first save
                if (!state.profileLoaded) {
                    state.profileLoaded = true;
                    saveData();
                }
                return true;

            } catch (error) {
                console.error('Save profile error:', error);
                updateSyncIndicator('synced');
                showToast('Error saving profile: ' + error.message, 'error');
                return false;
            }
        }

        function getUserProfileData() {
            return {
                businessName: state.userProfile?.businessName || "",
                email: state.userProfile?.email || currentUser?.email || "",
                phone: state.userProfile?.phone || "",
                address: state.userProfile?.address || ""
            };
        }

        function updateSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;

            if (status === 'synced' && syncEnabled) {
                indicator.textContent = '☁️ Synced';
                indicator.className = 'sync-indicator show';
            } else if (status === 'syncing') {
                indicator.textContent = '🔄 Syncing...';
                indicator.className = 'sync-indicator show syncing';
            } else {
                indicator.className = 'sync-indicator';
            }
        }

        async function signUp(email, password) {
            try {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                showToast('Account created! Check your email to confirm.', 'success');
                return data;
            } catch (error) {
                showToast('Sign up error: ' + error.message, 'error');
                return null;
            }
        }

        async function signIn(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;

                currentUser = data.user;
                syncEnabled = true;

                showToast('Signed in successfully!', 'success');

                // Load user profile first
                await loadUserProfile();

                // Check if local data exists
                const localHasData = state.sales.length > 0 || state.products.length > 0;

                try {
                    if (localHasData) {
                        // Smart merge - combine unique items by ID
                        await smartMergeData();
                        showToast('Local and cloud data merged successfully', 'success');
                    } else {
                        // No local data, just pull from cloud
                        await pullDataFromSupabase();
                        showToast('Cloud data loaded', 'success');
                    }
                } catch (syncError) {
                    console.error('Sync error after sign in:', syncError);
                    showToast('Signed in but sync failed. Try manual sync.', 'error');
                }

                return data;
            } catch (error) {
                console.error('Sign in error:', error);
                showToast('Sign in error: ' + error.message, 'error');
                currentUser = null;
                syncEnabled = false;
                return null;
            }
        }

        async function smartMergeData() {
            try {
                updateSyncIndicator('syncing');

                // Save local data BEFORE pulling from cloud
                const localData = {
                    sales: [...(state.sales || [])],
                    products: [...(state.products || [])],
                    expenses: [...(state.expenses || [])],
                    customers: [...(state.customers || [])],
                    transactions: [...(state.transactions || [])],
                    unpaidEntries: [...(state.unpaidEntries || [])],
                    notes: [...(state.notes || [])]
                };

                // Pull cloud data
                await pullDataFromSupabase();
                const cloudData = {
                    sales: [...(state.sales || [])],
                    products: [...(state.products || [])],
                    expenses: [...(state.expenses || [])],
                    customers: [...(state.customers || [])],
                    transactions: [...(state.transactions || [])],
                    unpaidEntries: [...(state.unpaidEntries || [])],
                    notes: [...(state.notes || [])]
                };

                // Improved merge function - prioritizes cloud data for existing IDs
                const mergeByID = (local, cloud) => {
                    const idMap = new Map();

                    // Add cloud items first (they take priority)
                    cloud.forEach(item => {
                        if (!item.id) item.id = generateID(getTypeFromItem(item));
                        idMap.set(item.id, item);
                    });

                    // Add local items only if ID doesn't exist
                    local.forEach(item => {
                        if (!item.id) item.id = generateID(getTypeFromItem(item));
                        if (!idMap.has(item.id)) {
                            idMap.set(item.id, item);
                        }
                    });

                    return Array.from(idMap.values());
                };

                // Merge each array
                state.sales = mergeByID(localData.sales, cloudData.sales);
                state.products = mergeByID(localData.products, cloudData.products);
                state.expenses = mergeByID(localData.expenses, cloudData.expenses);
                state.customers = mergeByID(localData.customers, cloudData.customers);
                state.transactions = mergeByID(localData.transactions, cloudData.transactions);
                state.unpaidEntries = mergeByID(localData.unpaidEntries, cloudData.unpaidEntries);
                state.notes = mergeByID(localData.notes, cloudData.notes);

                // Save merged data locally
                saveData();

                // Push merged data back to cloud
                await clearAndPushAllData();
                updateSyncIndicator('synced');

                console.log('✅ Smart merge completed successfully');
            } catch (error) {
                console.error('Smart merge error:', error);
                updateSyncIndicator('synced');
                throw error;
            }
        }

        function getTypeFromItem(item) {
            if (item.productName) return 'sales';
            if (item.cost !== undefined && item.price !== undefined) return 'products';
            if (item.description && item.category) return 'expenses';
            if (item.email !== undefined) return 'customers';
            if (item.channel) return 'transactions';
            if (item.paid !== undefined) return 'unpaid';
            if (item.content) return 'notes';
            return 'unknown';
        }

        async function signOut() {
            try {
                // Set these first in case signOut fails
                currentUser = null;
                syncEnabled = false;
                updateSyncIndicator('offline');

                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Sign out error:', error);
                    // Still consider it signed out locally
                }

                showToast('Signed out successfully', 'info');
                render();
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Signed out (with errors)', 'info');
                render();
            }
        }
        async function pushAllDataToSupabase() {
            if (!syncEnabled || !currentUser) return;

            updateSyncIndicator('syncing');

            try {
                // Sync products
                if (state.products.length > 0) {
                    const productsData = state.products.map(p => ({
                        user_id: currentUser.id,
                        name: p.name,
                        category: p.category,
                        cost: p.cost,
                        price: p.price
                    }));
                    await supabase.from('products').insert(productsData);
                }

                // Sync categories
                if (state.categories.length > 0) {
                    const categoriesData = state.categories.map(c => ({
                        user_id: currentUser.id,
                        name: c
                    }));
                    await supabase.from('categories').insert(categoriesData);
                }

                // Sync sales
                if (state.sales.length > 0) {
                    const salesData = state.sales.map(s => ({
                        user_id: currentUser.id,
                        date: s.date,
                        time: s.time,
                        timestamp: s.timestamp,
                        product_name: s.productName,
                        customer: s.customer,
                        quantity: s.quantity,
                        cost_per_unit: s.costPerUnit,
                        price_per_unit: s.pricePerUnit,
                        total_cost: s.totalCost,
                        total_price: s.totalPrice,
                        profit: s.profit,
                        payment: s.payment
                    }));
                    await supabase.from('sales').insert(salesData);
                }

                // Sync expenses
                if (state.expenses.length > 0) {
                    const expensesData = state.expenses.map(e => ({
                        user_id: currentUser.id,
                        date: e.date,
                        time: e.time,
                        timestamp: e.timestamp,
                        description: e.description,
                        category: e.category,
                        amount: e.amount,
                        payment: e.payment,
                        comment: e.comment || ''
                    }));
                    await supabase.from('expenses').insert(expensesData);
                }

                // Sync customers
                if (state.customers.length > 0) {
                    const customersData = state.customers.map(c => ({
                        user_id: currentUser.id,
                        name: c.name,
                        email: c.email || '',
                        phone: c.phone || '',
                        address: c.address || '',
                        total_purchases: c.totalPurchases || 0
                    }));
                    await supabase.from('customers').insert(customersData);
                }

                // Sync invoices
                if (state.invoices.length > 0) {
                    const invoicesData = state.invoices.map(i => ({
                        user_id: currentUser.id,
                        number: i.number,
                        customer: i.customer,
                        date: i.date,
                        due_date: i.dueDate,
                        items: i.items,
                        amount: i.amount,
                        status: i.status
                    }));
                    await supabase.from('invoices').insert(invoicesData);
                }

                // Sync receipts
                if (state.receipts && state.receipts.length > 0) {
                    const receiptsData = state.receipts.map(r => ({
                        user_id: currentUser.id,
                        number: r.number,
                        customer: r.customer,
                        customer_email: r.customerEmail || '',
                        date: r.date,
                        time: r.time,
                        timestamp: r.timestamp,
                        description: r.description,
                        amount: r.amount,
                        payment_method: r.paymentMethod
                    }));
                    await supabase.from('receipts').insert(receiptsData);
                }

                // Sync inventory
                if (Object.keys(state.inventory).length > 0) {
                    const inventoryData = Object.entries(state.inventory).map(([productName, inv]) => ({
                        user_id: currentUser.id,
                        product_name: productName,
                        stock: inv.stock,
                        min_alert: inv.minAlert
                    }));
                    await supabase.from('inventory').insert(inventoryData);
                }

                // Sync notes
                if (state.notes.length > 0) {
                    const notesData = state.notes.map(n => ({
                        user_id: currentUser.id,
                        title: n.title || '',
                        content: n.content,
                        date: n.date,
                        time: n.time,
                        timestamp: n.timestamp
                    }));
                    await supabase.from('notes').insert(notesData);
                }

                // Sync transactions
                if (state.transactions.length > 0) {
                    const transactionsData = state.transactions.map(t => ({
                        user_id: currentUser.id,
                        channel: t.channel,
                        customer_name: t.customerName,
                        type: t.type,
                        amount: t.amount,
                        date: t.date,
                        time: t.time,
                        timestamp: t.timestamp
                    }));
                    await supabase.from('transactions').insert(transactionsData);
                }

                // Sync unpaid entries
                if (state.unpaidEntries.length > 0) {
                    const unpaidData = state.unpaidEntries.map(u => ({
                        user_id: currentUser.id,
                        name: u.name,
                        type: u.type,
                        amount: u.amount,
                        date: u.date,
                        time: u.time,
                        timestamp: u.timestamp,
                        paid: u.paid
                    }));
                    await supabase.from('unpaid_entries').insert(unpaidData);
                }

                // Sync transaction floats
                const floatsData = Object.entries(state.transactionFloats).map(([channel, floatData]) => ({
                    user_id: currentUser.id,
                    channel: channel,
                    initial_float: floatData.initial
                }));
                await supabase.from('transaction_floats').insert(floatsData);

                // Sync settings
                await supabase.from('settings').insert({
                    user_id: currentUser.id,
                    daily_target: state.dailyTarget || 0,
                    monthly_target: state.monthlyTarget || 0
                });

                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Push error:', error);
                updateSyncIndicator('synced');
                throw error;
            }
        }

        async function syncAllData() {
            if (!syncEnabled || !currentUser) return;
            if (isSyncing) {
                console.log('Sync already in progress, skipping...');
                return;
            }

            isSyncing = true;
            updateSyncIndicator('syncing');

            try {
                console.log('🔄 Starting sync...');

                // Check if local data is essentially empty
                const localIsEmpty =
                    state.sales.length === 0 &&
                    state.products.length === 0 &&
                    state.expenses.length === 0;

                if (localIsEmpty) {
                    // Pull from cloud if local is empty
                    console.log('⬇️ Local data is empty, pulling from cloud...');
                    await pullDataFromSupabase();
                } else {
                    // Push local data to cloud
                    console.log('⬆️ Pushing local data to cloud...');
                    await clearAndPushAllData();
                }

                updateSyncIndicator('synced');
                showToast('Data synced successfully!', 'success');
                console.log('✅ Sync complete');
                render();
            } catch (error) {
                console.error('❌ Sync error:', error);
                updateSyncIndicator('synced');
                showToast('Sync failed: ' + error.message, 'error');
            } finally {
                isSyncing = false;
            }
        }

        async function clearAndPushAllData() {
            if (!syncEnabled || !currentUser) return;

            try {
                console.log('🗑️ Clearing cloud data...');

                // Wait for ALL deletes to complete before proceeding
                await Promise.all([
                    supabase.from('products').delete().eq('user_id', currentUser.id),
                    supabase.from('sales').delete().eq('user_id', currentUser.id),
                    supabase.from('categories').delete().eq('user_id', currentUser.id),
                    supabase.from('expenses').delete().eq('user_id', currentUser.id),
                    supabase.from('customers').delete().eq('user_id', currentUser.id),
                    supabase.from('invoices').delete().eq('user_id', currentUser.id),
                    supabase.from('receipts').delete().eq('user_id', currentUser.id),
                    supabase.from('inventory').delete().eq('user_id', currentUser.id),
                    supabase.from('notes').delete().eq('user_id', currentUser.id),
                    supabase.from('transactions').delete().eq('user_id', currentUser.id),
                    supabase.from('unpaid_entries').delete().eq('user_id', currentUser.id),
                    supabase.from('transaction_floats').delete().eq('user_id', currentUser.id),
                    supabase.from('settings').delete().eq('user_id', currentUser.id)
                ]);

                console.log('✅ Cloud data cleared');
                console.log('⬆️ Pushing local data to cloud...');

                // Now push all local data
                await pushAllDataToSupabase();

                console.log('✅ Local data pushed to cloud');
            } catch (error) {
                console.error('Clear and push error:', error);
                throw error;
            }
        }

        async function syncInBackground() {
            if (!syncEnabled || !currentUser) return;

            try {
                // Silent background sync - no loading indicators
                await clearAndPushAllData();
                console.log('✅ Background sync complete');
            } catch (error) {
                console.error('❌ Background sync error:', error);
                // Don't show error toast for background operations
            }
        }

        async function pullDataFromSupabase() {
            if (!syncEnabled || !currentUser) return;

            try {
                // Products
                const { data: products } = await supabase
                    .from('products')
                    .select('*')
                    .eq('user_id', currentUser.id);
                if (products) state.products = products.map(p => ({
                    id: `P-${p.name.replace(/\s+/g, '_')}_${Date.now()}`,
                    name: p.name,
                    category: p.category,
                    cost: parseFloat(p.cost),
                    price: parseFloat(p.price)
                }));

                // Sales
                const { data: sales } = await supabase
                    .from('sales')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('timestamp', { ascending: false });
                if (sales) state.sales = sales.map(s => ({
                    id: `S-${s.timestamp}`,
                    date: s.date,
                    time: s.time,
                    timestamp: s.timestamp,
                    productName: s.product_name,
                    customer: s.customer,
                    quantity: s.quantity,
                    costPerUnit: parseFloat(s.cost_per_unit),
                    pricePerUnit: parseFloat(s.price_per_unit),
                    totalCost: parseFloat(s.total_cost),
                    totalPrice: parseFloat(s.total_price),
                    profit: parseFloat(s.profit),
                    payment: s.payment
                }));

                // Categories
                const { data: categories } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('user_id', currentUser.id);
                if (categories) state.categories = categories.map(c => c.name);

                // Expenses
                const { data: expenses } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('user_id', currentUser.id);
                // Expenses
                if (expenses) state.expenses = expenses.map(e => ({
                    id: `E-${e.timestamp}`,
                    date: e.date,
                    time: e.time,
                    timestamp: e.timestamp,
                    description: e.description,
                    category: e.category,
                    amount: parseFloat(e.amount),
                    payment: e.payment,
                    comment: e.comment
                }));

                // Customers
                const { data: customers } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('user_id', currentUser.id);
                // Customers
                if (customers) state.customers = customers.map(c => ({
                    id: `C-${c.name.replace(/\s+/g, '_')}_${Date.now()}`,
                    name: c.name,
                    email: c.email || '',
                    phone: c.phone || '',
                    address: c.address || '',
                    totalPurchases: parseFloat(c.total_purchases || 0)
                }));

                // Invoices
                const { data: invoices } = await supabase
                    .from('invoices')
                    .select('*')
                    .eq('user_id', currentUser.id);
                // Invoices
                if (invoices) state.invoices = invoices.map(i => ({
                    id: `INV-${i.number}`,
                    number: i.number,
                    customer: i.customer,
                    date: i.date,
                    dueDate: i.due_date,
                    items: i.items,
                    amount: parseFloat(i.amount),
                    status: i.status
                }));

                // Receipts
                const { data: receipts } = await supabase
                    .from('receipts')
                    .select('*')
                    .eq('user_id', currentUser.id);
                if (receipts) state.receipts = receipts.map(r => ({
                    id: `RCPT-${r.timestamp}`,
                    number: r.number,
                    customer: r.customer,
                    customerEmail: r.customer_email || '',
                    date: r.date,
                    time: r.time,
                    timestamp: r.timestamp,
                    description: r.description,
                    amount: parseFloat(r.amount),
                    paymentMethod: r.payment_method
                }));

                // Inventory
                const { data: inventory } = await supabase
                    .from('inventory')
                    .select('*')
                    .eq('user_id', currentUser.id);
                if (inventory && inventory.length > 0) {
                    // Preserve existing inventory if not in cloud
                    if (!state.inventory) {
                        state.inventory = {};
                    }
                    inventory.forEach(item => {
                        state.inventory[item.product_name] = {
                            stock: parseInt(item.stock) || 0,
                            minAlert: parseInt(item.min_alert) || 5
                        };
                    });
                }

                // Don't reset inventory if cloud has no data - keep local data
                // Notes
                const { data: notes } = await supabase
                    .from('notes')
                    .select('*')
                    .eq('user_id', currentUser.id);
                // Notes
                if (notes) state.notes = notes.map(n => ({
                    id: `N-${n.timestamp}`,
                    title: n.title || '',
                    content: n.content,
                    date: n.date,
                    time: n.time,
                    timestamp: n.timestamp
                }));

                // Transactions
                const { data: transactions } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', currentUser.id);
                // Transactions
                if (transactions) state.transactions = transactions.map(t => ({
                    id: `T-${t.timestamp}`,
                    channel: t.channel,
                    customerName: t.customer_name,
                    type: t.type,
                    amount: parseFloat(t.amount),
                    date: t.date,
                    time: t.time,
                    timestamp: t.timestamp
                }));

                // Unpaid entries
                const { data: unpaidEntries } = await supabase
                    .from('unpaid_entries')
                    .select('*')
                    .eq('user_id', currentUser.id);
                // Unpaid entries
                if (unpaidEntries) state.unpaidEntries = unpaidEntries.map(u => ({
                    id: `U-${u.timestamp}`,
                    name: u.name,
                    type: u.type,
                    amount: parseFloat(u.amount),
                    date: u.date,
                    time: u.time,
                    timestamp: u.timestamp,
                    paid: u.paid
                }));

                // Transaction floats
                const { data: floats } = await supabase
                    .from('transaction_floats')
                    .select('*')
                    .eq('user_id', currentUser.id);
                if (floats) {
                    floats.forEach(f => {
                        if (state.transactionFloats[f.channel]) {
                            state.transactionFloats[f.channel].initial = parseFloat(f.initial_float);
                        }
                    });
                }

                // Settings
                const { data: settings } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                if (settings) {
                    state.dailyTarget = parseFloat(settings.daily_target || 0);
                    state.monthlyTarget = parseFloat(settings.monthly_target || 0);
                }

                calculateFloatBalances();
                saveData();
                setTimeout(() => {
                    render();
                }, 100);
            } catch (error) {
                console.error('Pull error:', error);
            }
        }
        async function pushToSupabase(table, data) {
            if (!syncEnabled || !currentUser) return;
            try {
                data.user_id = currentUser.id;
                await supabase.from(table).insert(data);
            } catch (error) {
                console.error(`Error syncing to ${table}:`, error);
            }
        }
        let state = {
            activeTab: 'dashboard',
            activeTransactionChannel: 'mpesa',
            products: [],
            sales: [],
            expenses: [],
            customers: [],
            invoices: [],
            receipts: [],
            categories: [],
            inventory: {},
            notes: [],
            transactions: [],
            unpaidEntries: [],
            currentNoteIndex: null,
            editingNoteIndex: null,
            collapsedSections: {},
            listExpanded: {},
            selectedItems: {},
            transactionFloats: {
                mpesa: { initial: 0, current: 0 },
                crdb: { initial: 0, current: 0 },
                nmb: { initial: 0, current: 0 },
                airtel: { initial: 0, current: 0 },
                halopesa: { initial: 0, current: 0 },
                yas: { initial: 0, current: 0 }
            },
            searchTerm: '',
            filterDateFrom: '',
            filterDateTo: '',
            filterCategory: '',
            filterCustomer: '',
            dailyTarget: 0,
            monthlyTarget: 0,
            userProfile: {
                businessName: "",
                email: "",
                phone: "",
                address: ""
            },
            profileEditMode: false,
            profileLoaded: false,
            privacyBlurred: true  // ADD THIS LINE
        };

        let chartInstance = null;
        let isSyncing = false;
        let idCounters = {              // ADD THIS ENTIRE OBJECT
            sales: 0,
            products: 0,
            expenses: 0,
            customers: 0,
            invoices: 0,
            categories: 0,
            notes: 0,
            transactions: 0,
            unpaid: 0
        };

        function getTodayDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`; // Returns: 2025-01-15
        }

        // ID Generation Functions
        function generateID(type) {
            const prefix = {
                'sales': 'S',
                'products': 'P',
                'expenses': 'E',
                'customers': 'C',
                'transactions': 'T',
                'unpaid': 'U',
                'notes': 'N',
                'categories': 'CAT',
                'invoices': 'INV'
            }[type] || 'X';

            let maxId = 0;
            const items = type === 'unpaid' ? state.unpaidEntries : (state[type] || []);

            items.forEach(item => {
                if (item.id && item.id.startsWith(prefix + '-')) {
                    const num = parseInt(item.id.split('-')[1]);
                    if (!isNaN(num) && num > maxId) maxId = num;
                }
            });

            return `${prefix}-${String(maxId + 1).padStart(6, '0')}`;
        }

        function ensureIDs() {
            // Add IDs to existing data
            state.sales.forEach(s => { if (!s.id) s.id = generateID('sales'); });
            state.products.forEach(p => { if (!p.id) p.id = generateID('products'); });
            state.expenses.forEach(e => { if (!e.id) e.id = generateID('expenses'); });
            state.customers.forEach(c => { if (!c.id) c.id = generateID('customers'); });
            state.transactions.forEach(t => { if (!t.id) t.id = generateID('transactions'); });
            state.unpaidEntries.forEach(u => { if (!u.id) u.id = generateID('unpaid'); });
            state.notes.forEach(n => { if (!n.id) n.id = generateID('notes'); });
        }

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0.00';
            return parseFloat(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function loadData() {
            const saved = localStorage.getItem('financeManagerData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };

                    // Ensure userProfile exists
                    if (!state.userProfile) {
                        state.userProfile = {
                            businessName: "",
                            email: "",
                            phone: "",
                            address: ""
                        };
                    }

                    // Ensure profileEditMode exists
                    if (state.profileEditMode === undefined) {
                        state.profileEditMode = false;
                    }

                    // Calculate current float balances
                    calculateFloatBalances();

                    // Ensure all items have IDs
                    ensureIDs();
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }

            // Always ensure IDs exist
            if (state.sales) ensureIDs();
        }

        function saveData() {
            try {
                localStorage.setItem('financeManagerData', JSON.stringify(state));
            } catch (e) {
                console.error('Error saving data:', e);
                showToast('Error saving data!', 'error');
            }
        }

        function calculateFloatBalances() {
            // Reset to initial values
            Object.keys(state.transactionFloats).forEach(channel => {
                state.transactionFloats[channel].current = state.transactionFloats[channel].initial;
            });

            // Apply all transactions
            (state.transactions || []).forEach(t => {
                if (state.transactionFloats[t.channel]) {
                    if (t.type === 'deposit') {
                        state.transactionFloats[t.channel].current += t.amount;
                    } else if (t.type === 'withdrawal') {
                        state.transactionFloats[t.channel].current -= t.amount;
                    }
                }
            });
        }

        function getStats() {
            const totalCapital = state.sales.reduce((sum, s) => sum + (s.totalCost || 0), 0);
            const totalProfit = state.sales.reduce((sum, s) => sum + (s.profit || 0), 0);
            const totalRevenue = state.sales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);

            const today = getTodayDateString();
            const todaySales = state.sales.filter(s => s.date === today);
            const todayProfit = todaySales.reduce((sum, s) => sum + (s.profit || 0), 0);
            const todayRevenue = todaySales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);

            const yesterdayDate = new Date(Date.now() - 86400000);
            const yesterday = `${yesterdayDate.getFullYear()}-${String(yesterdayDate.getMonth() + 1).padStart(2, '0')}-${String(yesterdayDate.getDate()).padStart(2, '0')}`;
            const yesterdayProfit = state.sales.filter(s => s.date === yesterday).reduce((sum, s) => sum + (s.profit || 0), 0);

            const now = new Date();
            const monthStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthStart = `${monthStartDate.getFullYear()}-${String(monthStartDate.getMonth() + 1).padStart(2, '0')}-${String(monthStartDate.getDate()).padStart(2, '0')}`;
            const monthSales = state.sales.filter(s => new Date(s.date) >= new Date(monthStart));
            const monthProfit = monthSales.reduce((sum, s) => sum + (s.profit || 0), 0);
            const monthRevenue = monthSales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);

            const totalExpenses = state.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const monthExpenses = state.expenses.filter(e => new Date(e.date) >= new Date(monthStart)).reduce((sum, e) => sum + (e.amount || 0), 0);

            const totalInvoiced = state.invoices.reduce((sum, inv) => sum + (inv.amount || 0), 0);
            const totalPaid = state.invoices.filter(inv => inv.status === 'Paid').reduce((sum, inv) => sum + (inv.amount || 0), 0);

            const netProfit = totalProfit - totalExpenses;
            const monthNetProfit = monthProfit - monthExpenses;

            return {
                totalCapital,
                totalProfit,
                totalRevenue,
                todayProfit,
                todayRevenue,
                yesterdayProfit,
                monthProfit,
                monthRevenue,
                monthNetProfit,
                totalExpenses,
                monthExpenses,
                totalInvoiced,
                totalPaid,
                netProfit,
                totalSalesCount: state.sales.length,
                todaySalesCount: todaySales.length
            };
        }


        const tabs = [
            { id: 'dashboard', label: 'Dashboard', icon: '📊' },
            { id: 'account', label: 'Account', icon: '👤' },  // ADD THIS LINE
            { id: 'sales', label: 'Sales', icon: '💰' },
            { id: 'transactions', label: 'Money', icon: '💳' },
            { id: 'products', label: 'Products', icon: '🛍️' },
            { id: 'categories', label: 'Categories', icon: '📁' },
            { id: 'expenses', label: 'Expenses', icon: '💸' },
            { id: 'inventory', label: 'Stock', icon: '📦' },
            { id: 'customers', label: 'Customers', icon: '👥' },
            { id: 'invoices', label: 'Invoices & Receipts', icon: '📄' }, ,
            { id: 'analytics', label: 'Analytics', icon: '📈' },
            { id: 'unpaid', label: 'Unpaid', icon: '⏳' },
            { id: 'notes', label: 'Notes', icon: '📝' }
        ];

        function renderNav() {
            const nav = document.getElementById('bottomNav');
            nav.innerHTML = tabs.map(tab => `
                <button class="nav-item ${state.activeTab === tab.id ? 'active' : ''}" onclick="switchTab('${tab.id}')">
                    <span class="nav-icon">${tab.icon}</span>
                    <span>${tab.label}</span>
                </button>
            `).join('');
        }

        function switchTab(tabId) {
            state.activeTab = tabId;
            // Reset privacy blur when switching away from sales
            if (tabId !== 'sales') {
                state.privacyBlurred = true;
            }
            render();
        }

        function showToast(message, type = "info") {
            const t = document.createElement('div');
            t.className = 'toast toast-' + type;
            t.textContent = message;
            document.body.appendChild(t);
            requestAnimationFrame(() => t.classList.add('show'));
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
        }

        function showConfirm(text, onYes) {
            if (confirm(text)) {
                onYes();
            }
        }

        function ensureWalkIn() {
            if (!state.customers) state.customers = [];
            const exists = state.customers.some(c => c && c.name && c.name.toString().toLowerCase().includes('walk'));
            if (!exists) {
                state.customers.unshift({ name: 'WALK IN', email: '', phone: '', address: '', totalPurchases: 0 });
                saveData();
            }
        }
        ensureWalkIn();

        function renderDashboard() {
            const stats = getStats();
            const lowStockProducts = state.products.filter(p => {
                const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
                return inv.stock <= inv.minAlert;
            });

            const unpaidCount = state.unpaidEntries.filter(e => !e.paid).length;
            const unpaidAmount = state.unpaidEntries.filter(e => !e.paid).reduce((sum, e) => sum + (e.amount || 0), 0);

            const dailyProgress = state.dailyTarget > 0 ? (stats.todayProfit / state.dailyTarget * 100) : 0;
            const monthlyProgress = state.monthlyTarget > 0 ? (stats.monthProfit / state.monthlyTarget * 100) : 0;

            return `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
        <div class="stat-card" onclick="switchTab('sales')" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">TODAY'S PROFIT</div>
            <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.todayProfit)} Tsh</div>
            <div class="stat-subvalue" style="font-size: 11px;">${stats.todaySalesCount} sales today</div>
            ${state.dailyTarget > 0 ? `
                <div class="progress-bar" style="height: 6px; margin-top: 6px;">
                    <div class="progress-fill" style="width: ${Math.min(dailyProgress, 100)}%"></div>
                </div>
                <div class="stat-subvalue" style="font-size: 10px; margin-top: 4px;">${dailyProgress.toFixed(0)}% of target</div>
            ` : ''}
        </div>
        
        <div class="stat-card" onclick="switchTab('sales')" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">YESTERDAY'S PROFIT</div>
            <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.yesterdayProfit)} Tsh</div>
            <div class="stat-subvalue" style="font-size: 10px;">
                ${stats.todayProfit > stats.yesterdayProfit ? '📈 Better!' :
                    stats.todayProfit < stats.yesterdayProfit ? '📉 Lower' : '➡️ Same'}
            </div>
        </div>

        <div class="stat-card" onclick="switchTab('analytics')" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">MONTH PROFIT</div>
            <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.monthProfit)} Tsh</div>
            <div class="stat-subvalue" style="font-size: 10px;">Revenue: ${formatNumber(stats.monthRevenue)} Tsh</div>
            ${state.monthlyTarget > 0 ? `
                <div class="progress-bar" style="height: 6px; margin-top: 6px;">
                    <div class="progress-fill" style="width: ${Math.min(monthlyProgress, 100)}%"></div>
                </div>
                <div class="stat-subvalue" style="font-size: 10px; margin-top: 4px;">${monthlyProgress.toFixed(0)}% of target</div>
            ` : ''}
        </div>

        <div class="stat-card" onclick="switchTab('analytics')" style="background: ${stats.monthNetProfit >= 0 ? '#2e7d32' : '#d32f2f'}; padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">NET PROFIT (MONTH)</div>
            <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.monthNetProfit)} Tsh</div>
            <div class="stat-subvalue" style="font-size: 10px;">Expenses: ${formatNumber(stats.monthExpenses)} Tsh</div>
        </div>

        <div class="stat-card" onclick="switchTab('unpaid')" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">UNPAID ENTRIES</div>
            <div class="stat-value" style="font-size: 18px;">${unpaidCount}</div>
            <div class="stat-subvalue" style="font-size: 10px;">Total: ${formatNumber(unpaidAmount)} Tsh</div>
        </div>

        <div class="stat-card" onclick="switchTab('inventory')" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">LOW STOCK ALERT</div>
            <div class="stat-value" style="font-size: 18px;">${lowStockProducts.length}</div>
            <div class="stat-subvalue" style="font-size: 10px;">${lowStockProducts.length > 0 ? '⚠️ Check inventory' : '✅ All good'}</div>
        </div>
    </div>

                ${lowStockProducts.length > 0 ? `
                    <div class="alert-box-danger">
                        <strong>⚠️ Low Stock Alert!</strong><br>
                        ${lowStockProducts.slice(0, 3).map(p => `• ${p.name}`).join('<br>')}
                        ${lowStockProducts.length > 3 ? `<br>...and ${lowStockProducts.length - 3} more` : ''}
                    </div>
                ` : ''}

                ${unpaidCount > 0 ? `
                    <div class="alert-box">
                        <strong>💰 Pending Payments</strong><br>
                        You have ${unpaidCount} unpaid entries totaling ${formatNumber(unpaidAmount)} Tsh
                    </div>
                ` : ''}

                <div class="card">
                    <h2>Quick Actions</h2>
                    <div class="flex-gap">
                        <button class="btn-success btn-small" onclick="switchTab('sales')">➕ New Sale</button>
                        <button class="btn-danger btn-small" onclick="switchTab('expenses')">💸 Add Expense</button>
                        <button class="btn-small" onclick="switchTab('products')">🛍️ Manage Products</button>
                        <button class="btn-small" onclick="switchTab('transactions')">💳 Transactions</button>
                    </div>
                </div>

                <div class="card">
                    <h2>Set Daily Target</h2>
                    <div class="form-group">
                        <label>Daily Profit Target (Tsh)</label>
                        <input type="number" id="dailyTarget" value="${state.dailyTarget || 0}" step="1000">
                    </div>
                    <button onclick="setDailyTarget()">Save Target</button>
                </div>

                <div class="card">
                    <h2>Set Monthly Target</h2>
                    <div class="form-group">
                        <label>Monthly Profit Target (Tsh)</label>
                        <input type="number" id="monthlyTarget" value="${state.monthlyTarget || 0}" step="10000">
                    </div>
                    <button onclick="setMonthlyTarget()">Save Target</button>
                </div>

                <div class="card">
                    <h2>Recent Activity</h2>
                    ${state.sales.slice().reverse().slice(0, 5).map(s => `
                        <div class="item">
                            <div class="item-header">
                                <span class="item-title">${s.productName}</span>
                                <span style="color: #2e7d32; font-weight: 700;">💱 ${formatNumber(s.profit)} Tsh</span>
                            </div>
                            <div class="item-subtitle">
                                ${s.date} ${s.time} | ${s.customer}
                            </div>
                        </div>
                    `).join('') || '<p style="text-align: center; color: #666;">No recent activity</p>'}
                </div>
            `;
        }

        async function setDailyTarget() {
            const value = parseFloat(document.getElementById('dailyTarget').value) || 0;
            state.dailyTarget = value;
            saveData();
            render();
            showToast('Daily target updated', 'success');

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        async function setMonthlyTarget() {
            const value = parseFloat(document.getElementById('monthlyTarget').value) || 0;
            state.monthlyTarget = value;
            saveData();
            render();
            showToast('Monthly target updated', 'success');

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function renderAccount() {
            if (!currentUser) {
                return `
            <div class="card">
                <h2>☁️ Cloud Sync</h2>
                <p style="margin-bottom: 16px; color: #666;">
                    Sign in to sync your data across all devices!
                </p>
                
                <div class="transaction-tabs" style="margin-bottom: 20px;">
                    <button class="transaction-tab mpesa active" id="loginTab" onclick="switchAuthTab('login')">
                        Sign In
                    </button>
                    <button class="transaction-tab crdb" id="signupTab" onclick="switchAuthTab('signup')">
                        Sign Up
                    </button>
                </div>

                <div id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="••••••••">
                    </div>
                    <button onclick="handleSignIn()">Sign In</button>
                </div>

                <div id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password (min 6 characters)</label>
                        <input type="password" id="signupPassword" placeholder="••••••••">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" placeholder="••••••••">
                    </div>
                    <button onclick="handleSignUp()">Create Account</button>
                </div>

                <div class="alert-info">
                    <strong>Benefits of Cloud Sync:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px; font-size: 13px; color: #666;">
                        <li>Access from any device</li>
                        <li>Automatic backup</li>
                        <li>Real-time updates</li>
                        <li>Never lose data</li>
                    </ul>
                </div>
            </div>
        `;
            }

            // Signed in view
            const profile = getUserProfileData();

            // Check if profile is incomplete (empty values)
            const isProfileIncomplete =
                !profile.businessName ||
                !profile.phone ||
                !profile.address;

            return `
        <div class="card">
            <h2>☁️ Account</h2>
            <div class="alert-success">
                <div style="font-size: 14px; margin-bottom: 8px;">
                    ✓ Connected to Cloud
                </div>
                <div style="font-size: 13px;">
                    📧 ${currentUser.email}
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <button onclick="pullFromCloud()" class="btn-success">
                    ⬇️ Pull from Cloud
                </button>
                <button onclick="pushToCloud()" class="btn-success">
                    ⬆️ Push to Cloud
                </button>
            </div>

            <button onclick="syncAllData()" class="btn" style="margin-bottom: 12px;">
                🔄 Smart Sync
            </button>
            
            <button onclick="forceRefresh()" class="btn-secondary" style="margin-bottom: 12px;">
                🔃 Refresh Dashboard
            </button>

            <button onclick="signOut()" class="btn-danger">
                Sign Out
            </button>

            <div class="alert-info">
                <strong>Sync Options:</strong><br>
                • <strong>Pull from Cloud:</strong> Download cloud data (overwrites local)<br>
                • <strong>Push to Cloud:</strong> Upload local data (overwrites cloud)<br>
                • <strong>Smart Sync:</strong> Auto-detect which direction to sync
            </div>
        </div>

        ${isProfileIncomplete && state.profileEditMode ? `
            <div class="alert-box" style="animation: highlightFade 2s ease-out;">
                <strong>📋 Complete Your Profile!</strong><br>
                Please fill in your business information below for personalized invoices and reports.
            </div>
        ` : ''}

        <div class="card" id="userProfileCard">
            <h2>👤 User Profile</h2>
            <form onsubmit="updateUserProfile(event)">
                <div class="form-group">
                    <label>Business Name</label>
                   <input 
                    type="text"
                    id="profileBusinessName"
                    value="${profile.businessName}"
                    placeholder="Enter business name"
                    ${state.profileEditMode ? '' : 'readonly'}
                    required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input 
                        type="email" 
                        id="profileEmail" 
                        value="${profile.email}" 
                        placeholder="youremail@domain.com" 
                        ${state.profileEditMode ? '' : 'readonly'}
                        required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input 
                        type="tel" 
                        id="profilePhone" 
                        value="${profile.phone}" 
                        placeholder="+00000000000" 
                        ${state.profileEditMode ? '' : 'readonly'}
                        required>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input 
                        type="text" 
                        id="profileAddress" 
                        value="${profile.address}" 
                        placeholder="your Address" 
                        ${state.profileEditMode ? '' : 'readonly'}
                        required>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button 
                        type="submit" 
                        class="btn-success" 
                        style="flex: 1; ${state.profileEditMode ? '' : 'opacity: 0.5; cursor: not-allowed;'}"
                        ${state.profileEditMode ? '' : 'disabled'}>
                        💾 Save Profile
                    </button>
                    
                    ${!state.profileEditMode ? `
                        <button 
                            type="button" 
                            class="btn" 
                            style="flex: 1;"
                            onclick="enableProfileEdit()">
                            ✏️ Edit
                        </button>
                    ` : ''}
                </div>
            </form>
            
            <div class="alert-info" style="margin-top: 16px;">
                <strong>📝 Note:</strong> This information will be used in invoices, reports, and other documents throughout the app.
            </div>
        </div>
    `;
        }

        async function updateUserProfile(e) {
            e.preventDefault();

            const profileData = {
                businessName: document.getElementById('profileBusinessName').value.trim(),
                email: document.getElementById('profileEmail').value.trim(),
                phone: document.getElementById('profilePhone').value.trim(),
                address: document.getElementById('profileAddress').value.trim()
            };

            const success = await saveUserProfile(profileData);

            if (success) {
                showToast('Profile updated successfully!', 'success');
                render();
            }
        }

        function enableProfileEdit() {
            state.profileEditMode = true;
            saveData();
            render();
        }

        async function updateUserProfile(e) {
            e.preventDefault();

            const profileData = {
                businessName: document.getElementById('profileBusinessName').value.trim(),
                email: document.getElementById('profileEmail').value.trim(),
                phone: document.getElementById('profilePhone').value.trim(),
                address: document.getElementById('profileAddress').value.trim()
            };

            const success = await saveUserProfile(profileData);

            if (success) {
                state.profileEditMode = false; // Disable edit mode after saving
                saveData();
                showToast('Profile updated successfully!', 'success');
                render();
            }
        }

        function switchAuthTab(tab) {
            if (tab === 'login') {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('signupTab').classList.remove('active');
            } else {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
                document.getElementById('loginTab').classList.remove('active');
                document.getElementById('signupTab').classList.add('active');
            }
        }
        async function pullFromCloud() {
            if (!syncEnabled || !currentUser) {
                return showToast('Not signed in', 'error');
            }

            if (!confirm('This will replace ALL local data with cloud data. Continue?')) {
                return;
            }

            updateSyncIndicator('syncing');

            try {
                console.log('⬇️ Pulling data from cloud...');

                // Clear local storage first
                localStorage.removeItem('financeManagerData');

                // Pull everything from cloud
                await pullDataFromSupabase();

                updateSyncIndicator('synced');
                showToast('Data pulled from cloud successfully!', 'success');
                render();
            } catch (error) {
                console.error('Pull error:', error);
                showToast('Pull failed: ' + error.message, 'error');
                updateSyncIndicator('synced');
            }
        }

        async function pushToCloud() {
            if (!syncEnabled || !currentUser) {
                return showToast('Not signed in', 'error');
            }

            if (!confirm('This will replace ALL cloud data with local data. Continue?')) {
                return;
            }

            updateSyncIndicator('syncing');

            try {
                console.log('⬆️ Pushing data to cloud...');
                await clearAndPushAllData();
                updateSyncIndicator('synced');
                showToast('Data pushed to cloud successfully!', 'success');
            } catch (error) {
                console.error('Push error:', error);
                showToast('Push failed: ' + error.message, 'error');
                updateSyncIndicator('synced');
            }
        }
        async function forceRefresh() {
            updateSyncIndicator('syncing');

            try {
                // Clear local storage
                localStorage.removeItem('financeManagerData');

                // Pull fresh data from cloud
                await pullDataFromSupabase();

                // Re-render everything
                render();

                updateSyncIndicator('synced');
                showToast('Dashboard refreshed!', 'success');
            } catch (error) {
                console.error('Refresh error:', error);
                showToast('Refresh failed: ' + error.message, 'error');
                updateSyncIndicator('synced');
            }
        }


        async function handleSignIn() {
            const email = document.getElementById('loginEmail')?.value;
            const password = document.getElementById('loginPassword')?.value;

            if (!email || !password) {
                return showToast('Please fill in all fields', 'error');
            }

            // Disable button during sign in
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                const buttons = loginForm.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
            }

            try {
                const result = await signIn(email, password);
                if (result) {
                    // Success - just render normally
                    render();
                } else {
                    // Failed - re-enable buttons
                    if (loginForm) {
                        const buttons = loginForm.querySelectorAll('button');
                        buttons.forEach(btn => btn.disabled = false);
                    }
                }
            } catch (error) {
                console.error('Handle sign in error:', error);
                if (loginForm) {
                    const buttons = loginForm.querySelectorAll('button');
                    buttons.forEach(btn => btn.disabled = false);
                }
            }
        }
        async function handleSignUp() {
            const email = document.getElementById('signupEmail')?.value;
            const password = document.getElementById('signupPassword')?.value;
            const confirm = document.getElementById('signupPasswordConfirm')?.value;

            if (!email || !password || !confirm) {
                return showToast('Please fill in all fields', 'error');
            }

            if (password !== confirm) {
                return showToast('Passwords do not match', 'error');
            }

            if (password.length < 6) {
                return showToast('Password must be at least 6 characters', 'error');
            }

            await signUp(email, password);
        }

        function renderSales() {
            const stats = getStats();

            // Filter sales based on search and filters
            let filteredSales = state.sales.slice();

            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filteredSales = filteredSales.filter(s =>
                    s.productName.toLowerCase().includes(term) ||
                    s.customer.toLowerCase().includes(term) ||
                    s.payment.toLowerCase().includes(term)
                );
            }

            if (state.filterDateFrom) {
                filteredSales = filteredSales.filter(s => new Date(s.date) >= new Date(state.filterDateFrom));
            }

            if (state.filterDateTo) {
                filteredSales = filteredSales.filter(s => new Date(s.date) <= new Date(state.filterDateTo));
            }

            if (state.filterCustomer) {
                filteredSales = filteredSales.filter(s => s.customer === state.filterCustomer);
            }

            return `
        <div class="privacy-container">
            <button class="privacy-toggle-btn show" id="privacyToggleBtn" onclick="togglePrivacy()">
                ${state.privacyBlurred ? '🔒' : '🔓'}
            </button>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">TOTAL CAPITAL</div>
                <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.totalCapital)} Tsh</div>
            </div>
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">TOTAL PROFIT</div>
                <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.totalProfit)} Tsh</div>
            </div>
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">TODAY'S PROFIT</div>
                <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.todayProfit)} Tsh</div>
            </div>
            <div class="stat-card ${state.privacyBlurred ? 'privacy-blur' : ''}" style="padding: 12px;">
                <div class="stat-label" style="font-size: 10px;">10% TODAY</div>
                <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.todayProfit * 0.1)} Tsh</div>
            </div>
        </div>
    </div>
</div>

        <div class="card">
            <h2>Add Sale</h2>
            <div class="card-header-buttons">
                <button class="quick-nav-btn products" onclick="switchTab('products')">Products</button>
                <button class="quick-nav-btn categories" onclick="switchTab('categories')">Categories</button>
            </div>
            <form onsubmit="addSale(event)">
                <div class="form-group">
                    <label>Product</label>
                    <select id="saleProduct" onchange="updateSaleTotal()" required>
                        <option value="">-- Select Product --</option>
                        ${state.products.map((p, i) => `<option value="${i}">${p.name} - ${p.category} (Stock: ${(state.inventory[p.name] || { stock: 0 }).stock})</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select id="saleCustomer" onchange="toggleCustomerInput()">
                        <option value="">-- Walk-in --</option>
                        ${state.customers.map((c, i) => `<option value="${i}">${c.name}</option>`).join('')}
                        <option value="new">+ Add New Customer</option>
                    </select>
                </div>
                <div id="newCustomerFields" style="display:none;">
                    <div class="form-group">
                        <label>New Customer Name</label>
                        <input type="text" id="newCustomerName" placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label>Phone (Optional)</label>
                        <input type="tel" id="newCustomerPhone" placeholder="+255...">
                    </div>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="saleQuantity" value="1" min="1" onchange="updateSaleTotal()" required>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="salePayment">
                        <option>Cash</option>
                        <option>Card</option>
                        <option>Mobile Money</option>
                        <option>M-Pesa Lipa Number</option>
                        <option>Bank Transfer</option>
                    </select>
                </div>
                <div id="saleInfo"></div>
                <button type="submit">Record Sale</button>
            </form>
        </div>

        <div class="card">
            <h2>Recent Sales (${filteredSales.length})</h2>
            
            <div class="search-box">
                <input type="text" placeholder="🔍 Search sales..." oninput="updateSearchTerm(this.value)">
            </div>

            <div class="filter-row">
                <div class="form-group">
                    <label>From...</label>
                    <input type="date" onchange="updateFilterDateFrom(this.value)" value="${state.filterDateFrom || ''}" placeholder="mm/dd/yyyy">
                </div>
                <div class="form-group">
                    <label>To...</label>
                    <input type="date" onchange="updateFilterDateTo(this.value)" value="${state.filterDateTo || ''}" placeholder="mm/dd/yyyy">
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select onchange="updateFilterCustomer(this.value)">
                        <option value="">All Customers</option>
                        ${[...new Set(state.sales.map(s => s.customer))].map(c =>
                `<option value="${c}" ${state.filterCustomer === c ? 'selected' : ''}>${c}</option>`
            ).join('')}
                    </select>
                </div>
                <button class="btn-small btn-secondary" onclick="clearFilters()">Clear</button>
            </div>

            ${(state.listExpanded.sales || state.searchTerm || state.filterDateFrom || state.filterDateTo || state.filterCustomer) ? `
                <div class="bulk-actions">
                    <input type="checkbox" id="selectAll_sales" onchange="toggleSelectAll('sales')" class="checkbox-select">
                    <label for="selectAll_sales">Select All</label>
                    <span style="color: #666; font-size: 12px; margin-left: 8px;">
                        ${getSelectedCount('sales')} selected
                    </span>
                    <button class="btn-small btn-danger" onclick="bulkDelete('sales')" ${!hasSelected('sales') ? 'disabled' : ''}>
                        🗑️ Delete Selected
                    </button>
                </div>

                ${filteredSales.slice().reverse().map((s, idx) => `
                    <div class="item">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <input type="checkbox" class="checkbox-select" 
                                   ${state.selectedItems.sales && state.selectedItems.sales[s.id] ? 'checked' : ''}
                                   onchange="toggleSelect('sales', '${s.id}')">
                            <div style="flex: 1;">
                                <div class="item-header">
                                    <span class="item-title">${s.productName}</span>
                                    <span style="color: #2e7d32; font-weight: 700;">💰 ${formatNumber(s.profit)} Tsh</span>
                                </div>
                                <div class="item-subtitle">
                                    ${s.date} ${s.time}<br>
                                    ${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>
                                    Cost: ${formatNumber(s.totalCost)} | Price: ${formatNumber(s.totalPrice)}
                                </div>
                                <div class="flex-gap" style="margin-top:8px;">
                                    <button class="btn-small" style="background: linear-gradient(145deg, #ffeb3b, #fbc02d); color: #333;" onclick="downloadSaleReceiptPDF(${s.timestamp})">📄 Receipt</button>
                                    <button class="btn-small" onclick="editSaleByTimestamp(${s.timestamp})">Edit</button>
                                    <button class="btn-small btn-danger" onclick="deleteSaleByTimestamp(${s.timestamp})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p style="text-align: center; color: #666;">No sales found</p>'}
            ` : ''}

            <button class="collapse-btn" onclick="toggleListExpanded('sales')">
                <span class="collapse-icon ${state.listExpanded.sales ? 'expanded' : ''}">▼</span>
                <span>${state.listExpanded.sales ? 'Hide' : 'Show'} All Sales</span>
            </button>
        </div>
    `;
        }


        function updateSearchTerm(value) {
            state.searchTerm = value;
            // Don't re-render, just update the list
            renderSalesList();
        }

        function renderSalesList() {
            const container = document.getElementById('salesList');
            if (!container) return;

            let filteredSales = state.sales.slice();

            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filteredSales = filteredSales.filter(s =>
                    s.productName.toLowerCase().includes(term) ||
                    s.customer.toLowerCase().includes(term) ||
                    s.payment.toLowerCase().includes(term)
                );
            }

            if (state.filterDateFrom) {
                filteredSales = filteredSales.filter(s => new Date(s.date) >= new Date(state.filterDateFrom));
            }

            if (state.filterDateTo) {
                filteredSales = filteredSales.filter(s => new Date(s.date) <= new Date(state.filterDateTo));
            }

            if (state.filterCustomer) {
                filteredSales = filteredSales.filter(s => s.customer === state.filterCustomer);
            }

            container.innerHTML = filteredSales.slice().reverse().slice(0, 50).map(s => `
        <div class="item">
            <div class="item-header">
                <span class="item-title">${s.productName}</span>
                <span style="color: #2e7d32; font-weight: 700;">💱 ${formatNumber(s.profit)} Tsh</span>
            </div>
            <div class="item-subtitle">
                ${s.date} ${s.time}<br>
                ${s.customer} | Qty: ${s.quantity} | ${s.payment}<br>
                Cost: ${formatNumber(s.totalCost)} | Price: ${formatNumber(s.totalPrice)}
            </div>
            <div class="flex-gap" style="margin-top:8px;">
                <button class="btn-small" onclick="editSaleByTimestamp(${s.timestamp})">Edit</button>
                <button class="btn-small btn-danger" onclick="deleteSaleByTimestamp(${s.timestamp})">Delete</button>
            </div>
        </div>
    `).join('') || '<p style="text-align: center; color: #666;">No sales found</p>';
        }

        function updateFilterDateFrom(value) {
            state.filterDateFrom = value;
            render();
        }

        function updateFilterDateTo(value) {
            state.filterDateTo = value;
            render();
        }

        function updateFilterCustomer(value) {
            state.filterCustomer = value;
            render();
        }

        function clearFilters() {
            state.searchTerm = '';
            state.filterDateFrom = '';
            state.filterDateTo = '';
            state.filterCategory = '';
            state.filterCustomer = '';
            render();
        }

        function renderCollapsibleList(items, chunkSize, sectionKey, renderItem, emptyMessage) {
            if (!items || items.length === 0) {
                return `<p style="text-align: center; color: #666;">${emptyMessage}</p>`;
            }

            let html = '';
            for (let i = 0; i < items.length; i += chunkSize) {
                const chunk = items.slice(i, i + chunkSize);
                const chunkId = `${sectionKey}_chunk_${i}`;
                const isCollapsed = state.collapsedSections[chunkId];

                html += chunk.map((item, idx) => renderItem(item, i + idx)).join('');

                if (i + chunkSize < items.length) {
                    html += `
                        <button class="collapse-btn" onclick="toggleCollapse('${chunkId}')">
                            <span class="collapse-icon ${isCollapsed ? '' : 'expanded'}">▼</span>
                            <span>${isCollapsed ? 'Show More' : 'Show Less'}</span>
                        </button>
                    `;

                    if (isCollapsed) {
                        break;
                    }
                }
            }
            return html;
        }

        function toggleCollapse(chunkId) {
            state.collapsedSections[chunkId] = !state.collapsedSections[chunkId];
            render();
        }

        function toggleListExpanded(key) {
            if (!state.listExpanded) state.listExpanded = {};
            state.listExpanded[key] = !state.listExpanded[key];
            render();
        }

        function toggleSelectAll(type) {
            if (!state.selectedItems[type]) state.selectedItems[type] = {};

            const items = type === 'unpaidEntries' ? state.unpaidEntries : state[type];

            // Ensure all items have IDs
            items.forEach(item => {
                if (!item.id) {
                    item.id = generateID(type);
                }
            });

            // Check if ALL items are currently selected
            const allSelected = items.every(item => state.selectedItems[type][item.id]);

            // Toggle: if all selected, unselect all; otherwise, select all
            const newState = !allSelected;

            // Apply the new state to all items
            items.forEach(item => {
                state.selectedItems[type][item.id] = newState;
            });

            saveData();
            render(); // Re-render to update UI
        }

        function updateSelectAllCheckbox(type) {
            // Use setTimeout to ensure DOM is ready
            setTimeout(() => {
                const items = type === 'unpaidEntries' ? state.unpaidEntries : state[type];
                const checkbox = document.getElementById(`selectAll_${type}`);

                if (!checkbox || !items || items.length === 0) return;

                // Ensure all items have IDs
                items.forEach(item => {
                    if (!item.id) {
                        item.id = generateID(type);
                    }
                });

                // Check if all items are selected
                const allSelected = items.every(item => state.selectedItems[type] && state.selectedItems[type][item.id]);

                // Update the "Select All" checkbox state
                checkbox.checked = allSelected;
            }, 0);
        }

        function toggleSelect(type, id) {
            if (!state.selectedItems[type]) state.selectedItems[type] = {};
            state.selectedItems[type][id] = !state.selectedItems[type][id];
            saveData();

            // Update the "Select All" checkbox state
            updateSelectAllCheckbox(type);

            // Update count display
            render();
        }

        function hasSelected(type) {
            return state.selectedItems[type] && Object.values(state.selectedItems[type]).some(v => v);
        }

        function getSelectedCount(type) {
            if (!state.selectedItems[type]) return 0;
            return Object.values(state.selectedItems[type]).filter(v => v).length;
        }

        function bulkDelete(type) {
            const selected = Object.keys(state.selectedItems[type] || {}).filter(id => state.selectedItems[type][id]);

            if (selected.length === 0) return showToast('No items selected', 'info');

            showConfirm(`Delete ${selected.length} selected items?`, async function () {
                const items = type === 'unpaidEntries' ? state.unpaidEntries : state[type];
                const filtered = items.filter(item => !selected.includes(item.id));

                if (type === 'unpaidEntries') {
                    state.unpaidEntries = filtered;
                } else {
                    state[type] = filtered;
                }

                // Reset selection state
                state.selectedItems[type] = {};
                saveData();
                render();

                // Uncheck select all checkbox after deletion
                setTimeout(() => {
                    const checkbox = document.getElementById(`selectAll_${type}`);
                    if (checkbox) checkbox.checked = false;
                }, 100);

                showToast(`${selected.length} items deleted`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        function bulkMarkPaid() {
            const selected = Object.keys(state.selectedItems.unpaidEntries || {})
                .filter(id => state.selectedItems.unpaidEntries[id]);

            if (selected.length === 0) return showToast('No items selected', 'info');

            showConfirm(`Mark ${selected.length} entries as paid?`, function () {
                selected.forEach(id => {
                    const entry = state.unpaidEntries.find(e => e.id === id);
                    if (entry) {
                        entry.paid = true;
                        const now = new Date();
                        state.sales.push({
                            id: generateID('sales'),
                            date: getTodayDateString(),
                            time: now.toLocaleTimeString(),
                            timestamp: now.getTime(),
                            productName: entry.type,
                            customer: entry.name,
                            quantity: 1,
                            costPerUnit: 0,
                            pricePerUnit: entry.amount,
                            totalCost: 0,
                            totalPrice: entry.amount,
                            profit: entry.amount,
                            payment: 'Unpaid Entry - Now Paid'
                        });
                    }
                });

                state.selectedItems.unpaidEntries = {};
                saveData();
                render();

                // Uncheck select all checkbox
                setTimeout(() => {
                    const checkbox = document.getElementById('selectAll_unpaidEntries');
                    if (checkbox) checkbox.checked = false;
                }, 100);

                showToast(`${selected.length} entries marked as paid`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        function editSaleByTimestamp(ts) {
            const idx = state.sales.findIndex(s => s.timestamp === ts);
            if (idx === -1) return showToast("Sale not found", "error");
            const s = state.sales[idx];
            const qty = prompt("Quantity:", s.quantity);
            const price = prompt("Price per unit:", s.pricePerUnit);
            if (qty && price && !isNaN(qty) && !isNaN(price)) {
                const qtyNum = parseInt(qty);
                const priceNum = parseFloat(price);
                s.quantity = qtyNum;
                s.pricePerUnit = priceNum;
                s.totalPrice = +(priceNum * qtyNum).toFixed(2);
                s.totalCost = s.costPerUnit * qtyNum;
                s.profit = +(s.totalPrice - s.totalCost).toFixed(2);
                s.timestamp = Date.now();
                saveData();
                render();
                showToast("Sale updated", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            }
        }

        function deleteSaleByTimestamp(ts) {
            showConfirm("Delete this sale?", async function () {
                const idx = state.sales.findIndex(s => s.timestamp === ts);
                if (idx === -1) return showToast("Sale not found", "error");
                const sale = state.sales[idx];

                // Return stock to inventory
                if (state.inventory[sale.productName]) {
                    state.inventory[sale.productName].stock += sale.quantity;
                }

                state.sales.splice(idx, 1);
                saveData();
                render();
                showToast("Sale deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }

        function toggleCustomerInput() {
            const select = document.getElementById('saleCustomer');
            const fields = document.getElementById('newCustomerFields');
            if (select && fields) {
                if (select.value === 'new') {
                    fields.style.display = 'block';
                } else {
                    fields.style.display = 'none';
                }
            }
        }

        function updateSaleTotal() {
            const productIndex = document.getElementById('saleProduct')?.value;
            const quantity = parseInt(document.getElementById('saleQuantity')?.value) || 1;
            const infoDiv = document.getElementById('saleInfo');
            if (!infoDiv) return;
            if (!productIndex && productIndex !== '0') { infoDiv.innerHTML = ''; return; }
            const product = state.products[productIndex];
            if (!product) { infoDiv.innerHTML = ''; return; }

            const inventoryItem = state.inventory[product.name] || { stock: 0, minAlert: 5 };
            const availableStock = inventoryItem.stock;

            if (quantity > availableStock) {
                infoDiv.innerHTML = `
                    <div class="alert-box-danger">
                        <strong>⚠️ Insufficient Stock!</strong><br>
                        Available: ${availableStock} units<br>
                        Requested: ${quantity} units
                    </div>
                `;
                return;
            }

            const totalCost = product.cost * quantity;
            const totalPrice = product.price * quantity;
            infoDiv.innerHTML = `
                <div class="info-box">
                    <div class="info-row"><span>Cost/unit:</span><span>💱 ${formatNumber(product.cost)} Tsh</span></div>
                    <div class="info-row"><span>Price/unit:</span>
                        <input type="number" id="manualPrice" value="${product.price.toFixed(2)}" step="0.01" style="width:120px;text-align:right;padding:6px;border-radius:6px;border:1px solid #ddd;">
                    </div>
                    <div class="info-row"><span>Available Stock:</span><span>${availableStock} units</span></div>
                    <div class="info-row" style="font-weight:700;"><span>Total Cost:</span><span id="totalCost">💱 ${formatNumber(totalCost)} Tsh</span></div>
                    <div class="info-row" style="font-weight:700;"><span>Total Price:</span><span id="totalPrice">💱 ${formatNumber(product.price * quantity)} Tsh</span></div>
                    <div class="info-row" style="font-weight:700; color: #2e7d32;"><span>Profit:</span><span id="totalProfit">💱 ${formatNumber((product.price - product.cost) * quantity)} Tsh</span></div>
                </div>
            `;
            const manual = document.getElementById('manualPrice');
            manual && manual.addEventListener('input', function () {
                const p = parseFloat(this.value) || 0;
                document.getElementById('totalPrice').textContent = `💱 ${formatNumber(p * quantity)} Tsh`;
                document.getElementById('totalProfit').textContent = `💱 ${formatNumber((p - product.cost) * quantity)} Tsh`;
            });
        }

        function addSale(e) {
            e && e.preventDefault && e.preventDefault();
            const productIndex = document.getElementById('saleProduct')?.value;
            if (productIndex === null || productIndex === '' || productIndex === undefined) return showToast('Please select a product', 'error');
            const product = state.products[productIndex];
            if (!product) return showToast('Product not found', 'error');

            const customerSelect = document.getElementById('saleCustomer')?.value;
            let customer;

            if (customerSelect === 'new') {
                const newName = document.getElementById('newCustomerName')?.value.trim();
                if (!newName) return showToast('Please enter customer name', 'error');
                const newPhone = document.getElementById('newCustomerPhone')?.value.trim();
                customer = { name: newName, email: '', phone: newPhone, address: '', totalPurchases: 0 };
                state.customers.push(customer);
            } else if (customerSelect) {
                customer = state.customers[customerSelect];
            } else {
                customer = { name: 'WALK IN' };
            }

            const quantity = parseInt(document.getElementById('saleQuantity')?.value) || 1;
            const payment = document.getElementById('salePayment')?.value || 'Cash';
            const manualPriceInput = document.getElementById('manualPrice');
            const pricePerUnit = manualPriceInput ? parseFloat(manualPriceInput.value) : product.price;

            // Check stock
            const inventoryItem = state.inventory[product.name] || { stock: 0, minAlert: 5 };
            if (quantity > inventoryItem.stock) {
                return showToast(`Insufficient stock! Available: ${inventoryItem.stock}`, 'error');
            }

            const now = new Date();
            const totalCost = product.cost * quantity;
            const totalPrice = +(pricePerUnit * quantity).toFixed(2);
            const sale = {
                id: generateID('sales'),
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                productName: product.name,
                customer: customer ? customer.name : 'WALK IN',
                quantity,
                costPerUnit: product.cost,
                pricePerUnit,
                totalCost,
                totalPrice,
                profit: +(totalPrice - totalCost).toFixed(2),
                payment
            };
            state.sales = state.sales || [];
            state.sales.push(sale);

            // Update customer total purchases
            if (customer && customer.name !== 'WALK IN') {
                const custIndex = state.customers.findIndex(c => c.name === customer.name);
                if (custIndex !== -1) {
                    state.customers[custIndex].totalPurchases = (state.customers[custIndex].totalPurchases || 0) + totalPrice;
                }
            }

            // Update inventory
            if (state.inventory && state.inventory[product.name]) {
                state.inventory[product.name].stock = Math.max(0, (state.inventory[product.name].stock || 0) - quantity);
            }

            saveData();
            render();
            showToast("Sale recorded successfully!", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function renderTransactions() {
            const channels = [
                { id: 'mpesa', label: 'M-Pesa' },
                { id: 'crdb', label: 'CRDB' },
                { id: 'nmb', label: 'NMB' },
                { id: 'airtel', label: 'Airtel Money' },
                { id: 'halopesa', label: 'Halopesa' },
                { id: 'yas', label: 'Yas Tanzania' }
            ];
            const currentChannel = state.activeTransactionChannel || 'mpesa';
            const channelTransactions = (state.transactions || []).filter(t => t.channel === currentChannel);

            const floatData = state.transactionFloats[currentChannel];
            const floatDifference = floatData.current - floatData.initial;

            return `
                <div class="transaction-tabs">
                    ${channels.map(ch => `
                        <button class="transaction-tab ${ch.id} ${currentChannel === ch.id ? 'active' : ''}" 
                             onclick="switchTransactionChannel('${ch.id}')">
                            ${ch.label}
                        </button>
                    `).join('')}
                </div>

                <div class="float-balance-container">
                    <h3 style="margin-bottom: 12px; color: #0d47a1; font-size: 16px;">💰 Float Balance</h3>
                    <div class="float-balance-row">
                        <span class="float-balance-label">Initial Float:</span>
                        <span class="editable-float" onclick="editInitialFloat('${currentChannel}')">
                            💱 ${formatNumber(floatData.initial)} Tsh
                        </span>
                    </div>
                    <div class="float-balance-row">
                        <span class="float-balance-label">Current Balance:</span>
                        <span class="float-balance-value ${floatDifference >= 0 ? 'positive' : 'negative'}">
                            💱 ${formatNumber(floatData.current)} Tsh
                        </span>
                    </div>
                    <div class="float-balance-row">
                        <span class="float-balance-label">Difference:</span>
                        <span class="float-balance-value ${floatDifference >= 0 ? 'positive' : 'negative'}">
                            ${floatDifference >= 0 ? '+' : ''}${formatNumber(floatDifference)} Tsh
                        </span>
                    </div>
                </div>

                </div>

        <div class="card">
            <h2>${channels.find(c => c.id === currentChannel).label} Transactions (${channelTransactions.length})</h2>
            
            <div class="search-box">
                <input type="text" placeholder="🔍 Search transactions..." 
                       oninput="searchTransactions(this.value)" 
                       id="transactionSearch">
            </div>
                <div class="card">
                    <h2>Add ${channels.find(c => c.id === currentChannel).label} Transaction</h2>
                    <form onsubmit="addTransaction(event)">
                        <div class="form-group">
                            <label>Customer Name (Optional)</label>
                            <input type="text" id="transactionCustomer" placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label>Transaction Type</label>
                            <select id="transactionType" required>
                                <option value="deposit">Deposit (+)</option>
                                <option value="withdrawal">Withdrawal (-)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" required>
                        </div>
                        <button type="submit">Save Transaction</button>
                    </form>
                </div>

                <div class="card">
                    <h2>${channels.find(c => c.id === currentChannel).label} Transactions (${channelTransactions.length})</h2>
                    
                    ${state.listExpanded.transactions ? `
    <div class="bulk-actions">
        <input type="checkbox" id="selectAll_transactions" onchange="toggleSelectAll('transactions')" class="checkbox-select">
        <label for="selectAll_transactions">Select All</label>
        <span style="color: #666; font-size: 12px; margin-left: 8px;">
            ${getSelectedCount('transactions')} selected
        </span>
        <button class="btn-small btn-danger" onclick="bulkDelete('transactions')" ${!hasSelected('transactions') ? 'disabled' : ''}>
            🗑️ Delete Selected
        </button>
    </div>

    <div id="transactionsList">
        ${renderTransactionsList(channelTransactions)}
    </div>
` : ''}

                    <button class="collapse-btn" onclick="toggleListExpanded('transactions')">
                        <span class="collapse-icon ${state.listExpanded.transactions ? 'expanded' : ''}">▼</span>
                        <span>${state.listExpanded.transactions ? 'Hide' : 'Show'} All Transactions</span>
                    </button>
                </div>
            `;
        }

        function renderTransactionsList(transactions, searchTerm = '') {
            let filtered = transactions;

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = transactions.filter(t =>
                    (t.customerName && t.customerName.toLowerCase().includes(term)) ||
                    t.type.toLowerCase().includes(term) ||
                    t.channel.toLowerCase().includes(term)
                );
            }

            if (filtered.length === 0) {
                return '<p style="text-align: center; color: #666;">No transactions found</p>';
            }

            return filtered.slice().reverse().map((t, idx) => `
        <div class="item">
            <div style="display: flex; gap: 12px; align-items: start;">
                <input type="checkbox" class="checkbox-select" 
                       ${state.selectedItems.transactions && state.selectedItems.transactions[t.id] ? 'checked' : ''}
                       onchange="toggleSelect('transactions', '${t.id}')">
                <div style="flex: 1;">
                    <div class="item-header">
                        <span class="item-title">${t.customerName || 'N/A'}</span>
                        <span class="badge badge-${t.channel}">${t.type.toUpperCase()}</span>
                    </div>
                    <div class="item-subtitle">
                        ${t.date} ${t.time}<br>
                        Amount: <strong style="color: ${t.type === 'deposit' ? '#2e7d32' : '#d32f2f'};">
                            ${t.type === 'deposit' ? '+' : '-'}💰 ${formatNumber(t.amount)} Tsh
                        </strong>
                    </div>
                    <div class="flex-gap" style="margin-top:8px;">
                        <button class="btn-small" onclick="editTransactionByTimestamp(${t.timestamp})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteTransactionByTimestamp(${t.timestamp})">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
        }

        function searchTransactions(term) {
            const currentChannel = state.activeTransactionChannel || 'mpesa';
            const channelTransactions = (state.transactions || []).filter(t => t.channel === currentChannel);

            document.getElementById('transactionsList').innerHTML = renderTransactionsList(channelTransactions, term);
        }

        async function editInitialFloat(channel) {
            const current = state.transactionFloats[channel].initial;
            const newValue = prompt(`Set initial float for ${channel.toUpperCase()}:`, current);
            if (newValue !== null) {
                const val = parseFloat(newValue);
                if (!isNaN(val) && val >= 0) {
                    state.transactionFloats[channel].initial = val;
                    calculateFloatBalances();
                    saveData();
                    render();
                    showToast('Float updated', 'success');

                    // Sync in background
                    if (syncEnabled) syncInBackground();
                } else {
                    showToast('Invalid amount', 'error');
                }
            }
        }
        function switchTransactionChannel(channel) {
            state.activeTransactionChannel = channel;
            render();
        }

        async function addTransaction(e) {
            e.preventDefault();
            const now = new Date();
            const amount = parseFloat(document.getElementById('transactionAmount').value);

            if (isNaN(amount) || amount <= 0) {
                return showToast('Please enter a valid amount', 'error');
            }

            const transaction = {
                id: generateID('transactions'),
                channel: state.activeTransactionChannel,
                customerName: document.getElementById('transactionCustomer').value.trim() || 'N/A',
                type: document.getElementById('transactionType').value,
                amount: amount,
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime()
            };

            state.transactions = state.transactions || [];
            state.transactions.push(transaction);

            calculateFloatBalances();
            saveData();
            render();
            showToast("Transaction recorded", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function editTransactionByTimestamp(ts) {
            const idx = state.transactions.findIndex(t => t.timestamp === ts);
            if (idx === -1) return showToast("Transaction not found", "error");
            const t = state.transactions[idx];
            const customer = prompt("Customer Name:", t.customerName);
            const type = confirm("Is this a DEPOSIT? (Cancel for Withdrawal)") ? 'deposit' : 'withdrawal';
            const amount = prompt("Amount:", t.amount);
            if (customer !== null && amount) {
                const amountNum = parseFloat(amount);
                if (!isNaN(amountNum) && amountNum > 0) {
                    t.customerName = customer.trim() || 'N/A';
                    t.type = type;
                    t.amount = amountNum;
                    t.timestamp = Date.now();
                    calculateFloatBalances();
                    saveData();
                    render();
                    showToast("Transaction updated", "success");

                    // Sync in background
                    if (syncEnabled) syncInBackground();
                } else {
                    showToast("Invalid amount", "error");
                }
            }
        }

        function deleteTransactionByTimestamp(ts) {
            showConfirm("Delete this transaction?", async function () {
                const idx = state.transactions.findIndex(t => t.timestamp === ts);
                if (idx === -1) return showToast("Transaction not found", "error");
                state.transactions.splice(idx, 1);
                calculateFloatBalances();
                saveData();
                render();
                showToast("Transaction deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }

        function renderProducts() {
            return `
                <div class="card">
                    <h2>Add Product</h2>
                    <div class="card-header-buttons">
                        <button class="quick-nav-btn back" onclick="switchTab('sales')">← Sales</button>
                    </div>
                    <form onsubmit="addProduct(event)">
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" id="productName" placeholder="Enter name" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="productCategory" required>
                                <option value="">-- Select Category --</option>
                                ${state.categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cost (Capital)</label>
                            <input type="number" id="productCost" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Price (Selling)</label>
                            <input type="number" id="productPrice" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Initial Stock</label>
                            <input type="number" id="productStock" placeholder="0" min="0" value="0">
                        </div>
                        <button type="submit">Add Product</button>
                    </form>
                </div>

                <div class="card">
                    <h2>All Products (${state.products.length})</h2>
    <div class="search-box">
        <input type="text" placeholder="🔍 Search products..." oninput="searchProducts(this.value)" id="productSearch">
    </div>
    
    ${state.products.length > 0 ? `
        <div class="bulk-actions">
            <input type="checkbox" id="selectAll_products" onchange="toggleSelectAll('products')" class="checkbox-select">
            <label for="selectAll_products">Select All</label>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">
                ${getSelectedCount('products')} selected
            </span>
            <button class="btn-small btn-danger" onclick="bulkDelete('products')" ${!hasSelected('products') ? 'disabled' : ''}>
                🗑️ Delete Selected
            </button>
        </div>
    ` : ''}
    
    <div id="productsList">
        ${renderProductsList()}
    </div>
</div>
            `;
        }

        function renderProductsList(searchTerm = '') {
            let products = state.products;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                products = products.filter(p =>
                    p.name.toLowerCase().includes(term) ||
                    p.category.toLowerCase().includes(term)
                );
            }

            if (products.length === 0) {
                return '<p style="text-align: center; color: #666;">No products found</p>';
            }

            return products.map((p, i) => {
                const actualIndex = state.products.indexOf(p);
                const inv = state.inventory[p.name] || { stock: 0 };
                const margin = ((p.price - p.cost) / p.cost * 100).toFixed(1);
                return `
        <div class="item">
            <div style="display: flex; gap: 12px; align-items: start;">
                <input type="checkbox" class="checkbox-select" 
                       ${state.selectedItems.products && state.selectedItems.products[p.id] ? 'checked' : ''}
                       onchange="toggleSelect('products', '${p.id}')">
                <div style="flex: 1;">
                        <div class="item-title">${p.name}</div>
                        <div class="item-subtitle">
                            Category: ${p.category} | Stock: ${inv.stock} units<br>
                            Margin: ${margin}%
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 14px;">
                            <span>Cost: 💱 ${formatNumber(p.cost)} Tsh</span>
                            <span>Price: 💱 ${formatNumber(p.price)} Tsh</span>
                            <span style="color: #2e7d32; font-weight: 600;">+${formatNumber(p.price - p.cost)} Tsh</span>
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                        <button class="btn-small" onclick="editProductIndex(${actualIndex})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteProductIndex(${actualIndex})">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    `;
            }).join('');
        }

        function searchProducts(term) {
            document.getElementById('productsList').innerHTML = renderProductsList(term);
        }

        async function addProduct(e) {
            e.preventDefault();
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const cost = parseFloat(document.getElementById('productCost').value);
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value) || 0;

            if (cost < 0 || price < 0) {
                return showToast('Cost and price must be positive', 'error');
            }

            if (price < cost) {
                if (!confirm('Warning: Selling price is less than cost. Continue?')) {
                    return;
                }
            }

            if (state.products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                return showToast('Product already exists', 'error');
            }

            const product = {
                id: generateID('products'),
                name,
                category,
                cost,
                price
            };
            state.products.push(product);

            // Initialize inventory for new product
            if (!state.inventory) {
                state.inventory = {};
            }

            // Always set initial stock when adding new product
            state.inventory[name] = {
                stock: parseInt(stock) || 0,
                minAlert: 5
            };

            saveData();
            render();
            showToast("Product added successfully!", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function editProductIndex(i) {
            const p = state.products[i];
            if (!p) return showToast("Product not found", "error");
            const name = prompt("Product name:", p.name);
            const cost = prompt("Cost:", p.cost);
            const price = prompt("Price:", p.price);
            if (name && cost && price && !isNaN(cost) && !isNaN(price)) {
                const costNum = parseFloat(cost);
                const priceNum = parseFloat(price);

                if (costNum < 0 || priceNum < 0) {
                    return showToast('Cost and price must be positive', 'error');
                }

                const oldName = p.name;
                p.name = name.trim();
                p.cost = costNum;
                p.price = priceNum;

                if (state.inventory && oldName !== p.name) {
                    state.inventory[p.name] = state.inventory[oldName] || { stock: 0, minAlert: 5 };
                    delete state.inventory[oldName];
                }
                saveData();
                render();
                showToast("Product updated", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            }
        }

        function deleteProductIndex(i) {
            showConfirm("Delete this product?", async function () {
                const p = state.products[i];
                if (p && p.name && state.inventory && state.inventory[p.name]) delete state.inventory[p.name];
                state.products.splice(i, 1);
                saveData();
                render();
                showToast("Product deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }
        function renderCategories() {
            return `
                <div class="card">
                    <h2>Add Category</h2>
                    <div class="card-header-buttons">
                        <button class="quick-nav-btn back" onclick="switchTab('products')">← Products</button>
                    </div>
                    <form onsubmit="addCategory(event)">
                        <div class="form-group">
                            <input type="text" id="categoryName" placeholder="Category Name" required>
                        </div>
                        <button type="submit">Add Category</button>
                    </form>
                </div>

               <div class="card">
    <h2>All Categories (${state.categories.length})</h2>
    
    ${state.categories.length > 0 ? `
        <div class="bulk-actions">
            <input type="checkbox" id="selectAll_categories" onchange="toggleSelectAllCategories()" class="checkbox-select">
            <label for="selectAll_categories">Select All</label>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">
                ${getSelectedCategoryCount()} selected
            </span>
            <button class="btn-small btn-danger" onclick="bulkDeleteCategories()" ${!hasSelectedCategories() ? 'disabled' : ''}>
                🗑️ Delete Selected
            </button>
        </div>
    ` : ''}
    
    ${state.categories.map((cat, i) => {
                return `
            <div class="item">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="checkbox" class="checkbox-select" 
                           ${state.selectedItems.categories && state.selectedItems.categories[i] ? 'checked' : ''}
                           onchange="toggleSelectCategory(${i})">
                    <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="item-title">${cat}</span>
                            <div class="item-subtitle">${state.products.filter(p => p.category === cat).length} products</div>
                        </div>
                        <div class="flex-gap">
                            <button class="btn-small" onclick="editCategoryIndex(${i})">Edit</button>
                            <button class="btn-small btn-danger" onclick="deleteCategoryIndex(${i})">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
            }).join('') || '<p style="text-align: center; color: #666;">No categories yet</p>'}
</div>
            `;
        }

        function toggleSelectAllCategories() {
            if (!state.selectedItems.categories) state.selectedItems.categories = {};

            // Check if all categories are currently selected
            const allSelected = state.categories.every((cat, i) => state.selectedItems.categories[i]);

            // Toggle: if all selected, unselect all; otherwise, select all
            const newState = !allSelected;

            state.categories.forEach((cat, i) => {
                state.selectedItems.categories[i] = newState;
            });

            saveData();
            render(); // RE-RENDER TO SHOW CHECKED ITEMS
        }

        function toggleSelectCategory(index) {
            if (!state.selectedItems.categories) state.selectedItems.categories = {};
            state.selectedItems.categories[index] = !state.selectedItems.categories[index];
            saveData();
            render(); // RE-RENDER TO UPDATE CHECKBOXES AND COUNT
        }

        function hasSelectedCategories() {
            return state.selectedItems.categories && Object.values(state.selectedItems.categories).some(v => v);
        }

        function getSelectedCategoryCount() {
            if (!state.selectedItems.categories) return 0;
            return Object.values(state.selectedItems.categories).filter(v => v).length;
        }

        function bulkDeleteCategories() {
            const selected = Object.keys(state.selectedItems.categories || {})
                .filter(i => state.selectedItems.categories[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No categories selected', 'info');

            showConfirm(`Delete ${selected.length} selected categories?`, async function () {
                // Sort in reverse to delete from end first
                selected.sort((a, b) => b - a).forEach(i => {
                    state.categories.splice(i, 1);
                });

                state.selectedItems.categories = {};
                saveData();
                render();
                showToast(`${selected.length} categories deleted`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        async function addCategory(e) {
            e.preventDefault();
            const name = document.getElementById('categoryName').value.trim();
            if (state.categories.includes(name)) return showToast('Category already exists', 'error');

            state.categories.push(name);
            saveData();
            render();
            showToast("Category added", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function editCategoryIndex(i) {
            const oldName = state.categories[i];
            const name = prompt("Category name:", oldName);
            if (name && name.trim()) {
                const newName = name.trim();
                if (state.categories.includes(newName) && newName !== oldName) {
                    return showToast('Category already exists', 'error');
                }
                state.categories[i] = newName;
                // Update products with this category
                state.products.forEach(p => {
                    if (p.category === oldName) p.category = newName;
                });
                saveData();
                render();
                showToast("Category updated", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            }
        }

        function deleteCategoryIndex(i) {
            const cat = state.categories[i];
            const productsInCategory = state.products.filter(p => p.category === cat).length;
            if (productsInCategory > 0) {
                if (!confirm(`This category has ${productsInCategory} products. Delete anyway?`)) {
                    return;
                }
            }
            showConfirm("Delete this category?", async function () {
                state.categories.splice(i, 1);
                saveData();
                render();
                showToast("Category deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }

        function renderExpenses() {
            const stats = getStats();

            let filteredExpenses = state.expenses.slice();

            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filteredExpenses = filteredExpenses.filter(e =>
                    e.description.toLowerCase().includes(term) ||
                    e.category.toLowerCase().includes(term)
                );
            }

            if (state.filterDateFrom) {
                filteredExpenses = filteredExpenses.filter(e => new Date(e.date) >= new Date(state.filterDateFrom));
            }

            if (state.filterDateTo) {
                filteredExpenses = filteredExpenses.filter(e => new Date(e.date) <= new Date(state.filterDateTo));
            }

            if (state.filterCategory) {
                filteredExpenses = filteredExpenses.filter(e => e.category === state.filterCategory);
            }

            return `
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL EXPENSES</div>
                        <div class="stat-value">💱 ${formatNumber(stats.totalExpenses)} Tsh</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">MONTH EXPENSES</div>
                        <div class="stat-value">💱 ${formatNumber(stats.monthExpenses)} Tsh</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Add Expense</h2>
                    <form onsubmit="addExpense(event)">
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="expenseDesc" placeholder="e.g., Rent, Utilities" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="expenseCategory">
                                <option>Rent</option>
                                <option>Utilities</option>
                                <option>Supplies</option>
                                <option>Salaries</option>
                                <option>Marketing</option>
                                <option>Transportation</option>
                                <option>Office Electricity bills</option>
                                <option>Waste disposal bills</option>
                                <option>Food Expenses</option>
                                <option>Miscellaneous</option>
                                <option>Machine Repair bills</option>
                                <option>Home rent</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="expensePayment">
                                <option>Cash</option>
                                <option>Card</option>
                                <option>Mobile Money</option>
                                <option>M-Pesa Lipa Number</option>
                                <option>Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Comment (Optional)</label>
                            <textarea id="expenseComment" placeholder="Additional notes..."></textarea>
                        </div>
                        <button type="submit">Add Expense</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Recent Expenses (${filteredExpenses.length})</h2>
                    
                    <div class="search-box">
                        <input type="text" placeholder="🔍 Search expenses..." oninput="updateSearchTerm(this.value)">
                    </div>

                    <div class="filter-row">
                        <input type="date" placeholder="From" onchange="updateFilterDateFrom(this.value)" value="${state.filterDateFrom || ''}">
                        <input type="date" placeholder="To" onchange="updateFilterDateTo(this.value)" value="${state.filterDateTo || ''}">
                        <select onchange="updateFilterCategory(this.value)">
                            <option value="">All Categories</option>
                            ${[...new Set(state.expenses.map(e => e.category))].map(c =>
                `<option value="${c}" ${state.filterCategory === c ? 'selected' : ''}>${c}</option>`
            ).join('')}
                        </select>
                        <button class="btn-small btn-secondary" onclick="clearFilters()">Clear</button>
                    </div>
                    </div>

    ${filteredExpenses.length > 0 ? `
        <div class="bulk-actions">
            <input type="checkbox" id="selectAll_expenses" onchange="toggleSelectAll('expenses')" class="checkbox-select">
            <label for="selectAll_expenses">Select All</label>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">
                ${getSelectedCount('expenses')} selected
            </span>
            <button class="btn-small btn-danger" onclick="bulkDelete('expenses')" ${!hasSelected('expenses') ? 'disabled' : ''}>
                🗑️ Delete Selected
            </button>
        </div>
    ` : ''}

                    ${filteredExpenses.slice().reverse().map((e, idx) => `
    <div class="item">
        <div style="display: flex; gap: 12px; align-items: start;">
            <input type="checkbox" class="checkbox-select" 
                   ${state.selectedItems.expenses && state.selectedItems.expenses[e.id] ? 'checked' : ''}
                   onchange="toggleSelect('expenses', '${e.id}')">
            <div style="flex: 1;">
                <div class="item-header">
                                <span class="item-title">${e.description}</span>
                                <span style="color: #d32f2f; font-weight: 700;">💱 ${formatNumber(e.amount)} Tsh</span>
                            </div>
                            <div class="item-subtitle">
                                ${e.date} | ${e.category} | ${e.payment}
                                ${e.comment ? '<br>💬 ' + e.comment : ''}
                            </div>
                            <div class="flex-gap" style="margin-top:8px;">
                                <button class="btn-small" onclick="editExpenseIndex(${state.expenses.length - 1 - idx})">Edit</button>
                                <button class="btn-small btn-danger" onclick="deleteExpenseIndex(${state.expenses.length - 1 - idx})">Delete</button>
                       </div>
                </div>
            </div>
        </div>
    </div>
                    `).join('') || '<p style="text-align: center; color: #666;">No expenses yet</p>'}
                </div>
            `;
        }

        function updateFilterCategory(value) {
            state.filterCategory = value;
            render();
        }

        async function addExpense(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            if (isNaN(amount) || amount <= 0) {
                return showToast('Please enter a valid amount', 'error');
            }

            const now = new Date();  // ✅ ADD THIS LINE

            const expense = {
                id: generateID('expenses'),
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                description: document.getElementById('expenseDesc').value.trim(),
                category: document.getElementById('expenseCategory').value,
                amount: amount,
                payment: document.getElementById('expensePayment').value,
                comment: document.getElementById('expenseComment').value.trim()
            };

            state.expenses.push(expense);
            saveData();
            render();
            showToast("Expense added", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function editExpenseIndex(i) {
            const e = state.expenses[i];
            if (!e) return showToast("Expense not found", "error");
            const desc = prompt("Description:", e.description);
            const amt = prompt("Amount:", e.amount);
            if (desc && amt) {
                const amtNum = parseFloat(amt);
                if (!isNaN(amtNum) && amtNum > 0) {
                    e.description = desc.trim();
                    e.amount = amtNum;
                    e.timestamp = Date.now();
                    saveData();
                    render();
                    showToast("Expense updated", "success");

                    // Sync in background
                    if (syncEnabled) syncInBackground();
                } else {
                    showToast("Invalid amount", "error");
                }
            }
        }

        function deleteExpenseIndex(i) {
            showConfirm("Delete this expense?", async function () {
                state.expenses.splice(i, 1);
                saveData();
                render();
                showToast("Expense deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }

        function renderInventory() {
            const lowStock = state.products.filter(p => {
                const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
                return inv.stock <= inv.minAlert;
            });

            return `
                ${lowStock.length > 0 ? `
                    <div class="alert-box-danger">
                        <strong>⚠️ ${lowStock.length} Products Low on Stock!</strong>
                    </div>
                ` : ''}

                <div class="card">
                    <h2>Stock Levels (${state.products.length} Products)</h2>
                    ${state.products.map(p => {
                const inv = state.inventory[p.name] || { stock: 0, minAlert: 5 };
                const isLow = inv.stock <= inv.minAlert;
                const stockValue = inv.stock * p.cost;
                return `
                            <div class="item" style="${isLow ? 'border-left: 4px solid #d32f2f;' : ''}">
                                <div class="item-header">
                                    <span class="item-title">${p.name}</span>
                                    <span class="badge ${isLow ? 'badge-danger' : 'badge-success'}">
                                        ${isLow ? '⚠️ LOW' : '✅ OK'}
                                    </span>
                                </div>
                                <div class="item-subtitle">
                                    Stock: ${inv.stock} units | Min Alert: ${inv.minAlert}<br>
                                    Value: 💱 ${formatNumber(stockValue)} Tsh
                                </div>
                                <div class="flex-gap" style="margin-top: 8px;">
                                    <button class="btn-success btn-small" onclick="adjustStock('${p.name}', 10)">+10</button>
                                    <button class="btn-success btn-small" onclick="adjustStock('${p.name}', 1)">+1</button>
                                    <button class="btn-danger btn-small" onclick="adjustStock('${p.name}', -1)">-1</button>
                                    <input type="number" id="inv_input_${encodeURIComponent(p.name)}" value="${inv.stock}" min="0" style="width:80px;padding:6px;">
                                    <button class="btn-small" onclick="saveStockFor('${p.name}')">Save</button>
                                    <button class="btn-small btn-secondary" onclick="setMinAlert('${p.name}')">⚠️ ${inv.minAlert}</button>
                                </div>
                            </div>
                        `;
            }).join('') || '<p style="text-align: center; color: #666;">No products yet</p>'}
                </div>
            `;
        }

        function adjustStock(productName, amount) {
            if (!state.inventory[productName]) {
                state.inventory[productName] = { stock: 0, minAlert: 5 };
            }
            state.inventory[productName].stock = Math.max(0, state.inventory[productName].stock + amount);
            saveData();
            render();
            showToast(`Stock ${amount > 0 ? 'increased' : 'decreased'}`, 'success');

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        async function saveStockFor(productName) {
            const el = document.getElementById('inv_input_' + encodeURIComponent(productName));
            if (!el) return showToast("Input not found", "error");
            const v = parseInt(el.value);
            if (isNaN(v) || v < 0) return showToast("Invalid value", "error");
            if (!state.inventory) state.inventory = {};
            state.inventory[productName] = state.inventory[productName] || { stock: 0, minAlert: 5 };
            state.inventory[productName].stock = v;

            saveData();
            render();
            showToast("Stock updated", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function setMinAlert(productName) {
            const current = state.inventory[productName]?.minAlert || 5;
            const newValue = prompt(`Set minimum stock alert for ${productName}:`, current);
            if (newValue !== null) {
                const val = parseInt(newValue);
                if (!isNaN(val) && val >= 0) {
                    if (!state.inventory[productName]) {
                        state.inventory[productName] = { stock: 0, minAlert: 5 };
                    }
                    state.inventory[productName].minAlert = val;
                    saveData();
                    render();
                    showToast('Min alert updated', 'success');

                    // Sync in background
                    if (syncEnabled) syncInBackground();
                } else {
                    showToast('Invalid value', 'error');
                }
            }
        }

        function renderCustomers() {
            // Sort customers by total purchases
            const sortedCustomers = [...state.customers].sort((a, b) =>
                (b.totalPurchases || 0) - (a.totalPurchases || 0)
            );

            return `
                <div class="card">
                    <h2>Add Customer</h2>
                    <form onsubmit="addCustomer(event)">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="customerName" placeholder="Full name" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="customerEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="customerPhone" placeholder="+255...">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="customerAddress" placeholder="Address">
                        </div>
                        <button type="submit">Add Customer</button>
                    </form>
                </div>

                <div class="card">
    <h2>All Customers (${state.customers.length})</h2>
    <div class="search-box">
        <input type="text" placeholder="🔍 Search customers..." oninput="searchCustomers(this.value)" id="customerSearch">
    </div>
    
    ${state.customers.length > 0 ? `
        <div class="bulk-actions">
            <input type="checkbox" id="selectAll_customers" onchange="toggleSelectAll('customers')" class="checkbox-select">
            <label for="selectAll_customers">Select All</label>
            <span style="color: #666; font-size: 12px; margin-left: 8px;">
                ${getSelectedCount('customers')} selected
            </span>
            <button class="btn-small btn-danger" onclick="bulkDelete('customers')" ${!hasSelected('customers') ? 'disabled' : ''}>
                🗑️ Delete Selected
            </button>
        </div>
    ` : ''}
    
    <div id="customersList">
        ${renderCustomersList()}
    </div>
</div>
            `;
        }

        function renderCustomersList(searchTerm = '') {
            let customers = state.customers;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                customers = customers.filter(c =>
                    c.name.toLowerCase().includes(term) ||
                    (c.email && c.email.toLowerCase().includes(term)) ||
                    (c.phone && c.phone.includes(term))
                );
            }

            if (customers.length === 0) {
                return '<p style="text-align: center; color: #666;">No customers found</p>';
            }

            return customers.map((c, i) => {
                const actualIndex = state.customers.indexOf(c);
                const purchaseCount = state.sales.filter(s => s.customer === c.name).length;
                return `
        <div class="item">
            <div style="display: flex; gap: 12px; align-items: start;">
                <input type="checkbox" class="checkbox-select" 
                       ${state.selectedItems.customers && state.selectedItems.customers[c.id] ? 'checked' : ''}
                       onchange="toggleSelect('customers', '${c.id}')">
                <div style="flex: 1;">
                    <div class="item-title">${c.name}</div>
                        <div class="item-subtitle">
                            ${c.email ? '📧 ' + c.email + '<br>' : ''}
                            ${c.phone ? '📱 ' + c.phone + '<br>' : ''}
                            ${c.address ? '📍 ' + c.address + '<br>' : ''}
                            <div style="color: #2e7d32; font-weight: 600; margin-top: 4px;">
                                💰 Total Purchases: 💱 ${formatNumber(c.totalPurchases || 0)} Tsh<br>
                                📊 ${purchaseCount} transactions
                            </div>
                        </div>
                        <div class="flex-gap" style="margin-top:8px;">
                        <button class="btn-small" onclick="viewCustomerHistory(${actualIndex})">History</button>
                        <button class="btn-small" onclick="editCustomerIndex(${actualIndex})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteCustomerIndex(${actualIndex})">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    `;
            }).join('');
        }

        function searchCustomers(term) {
            document.getElementById('customersList').innerHTML = renderCustomersList(term);
        }

        function viewCustomerHistory(i) {
            const customer = state.customers[i];
            if (!customer) return showToast("Customer not found", "error");

            const sales = state.sales.filter(s => s.customer === customer.name);

            if (sales.length === 0) {
                showToast("No purchase history", "info");
                return;
            }

            let history = `${customer.name}'s Purchase History:\n\n`;
            sales.slice(-10).reverse().forEach(s => {
                history += `${s.date}: ${s.productName} - ${formatNumber(s.totalPrice)} Tsh\n`;
            });

            alert(history);
        }

        async function addCustomer(e) {
            e.preventDefault();
            const name = document.getElementById('customerName').value.trim();

            if (state.customers.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                return showToast('Customer already exists', 'error');
            }

            const customer = {
                id: generateID('customers'),
                name: name,
                email: document.getElementById('customerEmail').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                address: document.getElementById('customerAddress').value.trim(),
                totalPurchases: 0
            };

            state.customers.push(customer);
            saveData();
            render();
            showToast("Customer added", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }
        function editCustomerIndex(i) {
            const c = state.customers[i];
            if (!c) return showToast("Customer not found", "error");
            const name = prompt("Name:", c.name);
            const email = prompt("Email:", c.email);
            const phone = prompt("Phone:", c.phone);
            if (name) {
                c.name = name.trim();
                if (email !== null) c.email = email.trim();
                if (phone !== null) c.phone = phone.trim();
                saveData();
                render();
                showToast("Customer updated", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            }
        }

        function deleteCustomerIndex(i) {
            showConfirm("Delete this customer?", async function () {
                state.customers.splice(i, 1);
                saveData();
                render();
                showToast("Customer deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }

        function renderInvoices() {
            const stats = getStats();
            return `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
        <div class="stat-card" style="padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">TOTAL INVOICED</div>
            <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.totalInvoiced)} Tsh</div>
        </div>
        <div class="stat-card" style="background: #2e7d32; padding: 12px;">
            <div class="stat-label" style="font-size: 10px;">PAID</div>
            <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.totalPaid)} Tsh</div>
        </div>
    </div>

    <!-- Template Selection Tabs -->
    <div class="card">
        <h2>📋 Create Document</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
            <button class="transaction-tab ${state.activeInvoiceTab === 'invoice' ? 'mpesa active' : 'mpesa'}" 
                    style="opacity: ${state.activeInvoiceTab === 'invoice' ? '1' : '0.6'};"
                    onclick="switchInvoiceTab('invoice')">
                📄 Invoice
            </button>
            <button class="transaction-tab ${state.activeInvoiceTab === 'receipt' ? 'crdb active' : 'crdb'}" 
                    style="opacity: ${state.activeInvoiceTab === 'receipt' ? '1' : '0.6'};"
                    onclick="switchInvoiceTab('receipt')">
                🧾 Receipt
            </button>
        </div>

        ${state.activeInvoiceTab === 'invoice' ? `
            <!-- Invoice Creation Form -->
            <form onsubmit="createInvoice(event)">
                <div class="form-group">
                    <label>Customer</label>
                    <select id="invoiceCustomer" onchange="toggleInvoiceCustomerInput()" required>
                        <option value="">-- Select Customer --</option>
                        ${state.customers.map((c, i) => `<option value="${i}">${c.name}</option>`).join('')}
                        <option value="new">+ Add New Customer</option>
                    </select>
                </div>
                <div id="newInvoiceCustomerFields" style="display:none;">
                    <div class="form-group">
                        <label>New Customer Name</label>
                        <input type="text" id="newInvoiceCustomerName" placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label>Phone (Optional)</label>
                        <input type="tel" id="newInvoiceCustomerPhone" placeholder="+255...">
                    </div>
                    <div class="form-group">
                        <label>Email (Optional)</label>
                        <input type="email" id="newInvoiceCustomerEmail" placeholder="customer@email.com">
                    </div>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" id="invoiceDueDate" required>
                </div>
                <div class="form-group">
                    <label>Payment Terms</label>
                    <input type="text" id="invoiceTerms" placeholder="Due within 7 days" value="Due within 7 days">
                </div>
                <<div class="form-group">
    <label>Items/Services</label>
    <div id="invoiceItemsList">
        <div class="invoice-item-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" class="item-description" placeholder="Item description" style="flex: 2;" required>
            <input type="number" class="item-amount" placeholder="0.00" step="0.01" style="flex: 1;" required>
            <button type="button" class="btn-small btn-danger" onclick="removeInvoiceItem(this)" style="width: auto; padding: 8px 12px;">✕</button>
        </div>
    </div>
    <button type="button" class="btn-secondary" onclick="addInvoiceItem()" style="margin-top: 8px;">+ Add Item</button>
</div>
<div class="form-group">
    <label>Subtotal (Auto-calculated)</label>
    <input type="text" id="invoiceSubtotal" readonly value="0.00 Tsh" style="background: rgba(0,0,0,0.05);">
</div>
                <div class="form-group">
                    <label>Tax Rate (%)</label>
                    <input type="number" id="invoiceTaxRate" placeholder="0" step="0.01" value="0" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <input type="text" id="invoicePaymentMethod" placeholder="Bank Transfer / Mobile Money" value="Bank Transfer / Mobile Money">
                </div>
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="invoiceNotes" placeholder="Thank you for your business..."></textarea>
                </div>
                <button type="submit">Create Invoice</button>
            </form>
        ` : `
            <!-- Receipt Creation Form -->
<form onsubmit="createReceipt(event)">
    <div class="form-group">
        <label>Received From</label>
        <select id="receiptCustomer" onchange="updateReceiptFromCustomer()" required>
            <option value="">-- Select Customer --</option>
            ${state.customers.map((c, i) => `<option value="${i}">${c.name}</option>`).join('')}
            <option value="manual">✏️ Enter Manually</option>
        </select>
    </div>
    <div id="manualReceiptCustomerField" style="display:none;">
        <div class="form-group">
            <label>Customer Name</label>
            <input type="text" id="manualReceiptCustomerName" placeholder="Enter customer name">
        </div>
        <div class="form-group">
            <label>Customer Email (Optional)</label>
            <input type="email" id="manualReceiptCustomerEmail" placeholder="customer@email.com">
        </div>
    </div>
    <div class="form-group" id="invoiceSelectionGroup" style="display:none;">
        <label>Related Invoice (Optional)</label>
        <select id="receiptInvoice" onchange="updateReceiptFromInvoice()">
            <option value="">-- No Invoice --</option>
        </select>
    </div>
    <div class="form-group">
        <label>Description</label>
        <textarea id="receiptDescription" placeholder="Payment for services rendered" required></textarea>
    </div>
                <div class="form-group">
                    <label>Amount Paid</label>
                    <input type="number" id="receiptAmount" placeholder="0.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="receiptPaymentMethod">
                        <option>Cash</option>
                        <option>M-Pesa</option>
                        <option>Bank Transfer</option>
                        <option>Card</option>
                        <option>Airtel Money</option>
                        <option>Halopesa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reference Number (Optional)</label>
                    <input type="text" id="receiptReference" placeholder="REF123XYZ">
                </div>
                <button type="submit">Create Receipt</button>
            </form>
        `}
    </div>

    <!-- Unpaid Invoices -->
    <div class="card">
        <h2>Unpaid Invoices (${state.invoices.filter(i => i.status !== 'Paid').length})</h2>
        
        ${state.invoices.filter(i => i.status !== 'Paid').length > 0 ? `
            <div class="bulk-actions">
                <input type="checkbox" id="selectAll_unpaid_invoices" onchange="toggleSelectAllUnpaidInvoices()" class="checkbox-select">
                <label for="selectAll_unpaid_invoices">Select All</label>
                <span style="color: #666; font-size: 12px; margin-left: 8px;">
                    ${getSelectedUnpaidInvoiceCount()} selected
                </span>
                <button class="btn-small btn-success" onclick="bulkMarkInvoicesPaid()" ${!hasSelectedUnpaidInvoices() ? 'disabled' : ''}>
                    ✓ Mark as Paid
                </button>
                <button class="btn-small btn-danger" onclick="bulkDeleteUnpaidInvoices()" ${!hasSelectedUnpaidInvoices() ? 'disabled' : ''}>
                    🗑️ Delete Selected
                </button>
            </div>
            
            ${state.invoices.filter(i => i.status !== 'Paid').map((inv, origIdx) => {
                const actualIndex = state.invoices.findIndex(i => i === inv);
                return `
                <div class="item">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" class="checkbox-select" 
                               ${state.selectedItems.unpaid_invoices && state.selectedItems.unpaid_invoices[actualIndex] ? 'checked' : ''}
                               onchange="toggleSelectUnpaidInvoice(${actualIndex})">
                        <div style="flex: 1;">
                            <div class="item-header">
                                <span class="item-title">${inv.number}</span>
                                <span class="badge ${inv.status === 'Overdue' ? 'badge-danger' : 'badge-warning'}">
                                    ${inv.status}
                                </span>
                            </div>
                            <div class="item-subtitle">
                                ${inv.customer}<br>
                                Due: ${inv.dueDate}<br>
                                <span style="font-weight: 700; color: #000;">Amount: 💰 ${formatNumber(inv.amount)} Tsh</span>
                            </div>
                            <div class="flex-gap" style="margin-top:8px;">
                                <button class="btn-small" onclick="downloadInvoicePDF(${actualIndex})">📥 Invoice PDF</button>
                                <button class="btn-small" onclick="toggleInvoiceStatus(${actualIndex})">Change Status</button>
                                <button class="btn-small btn-danger" onclick="deleteInvoice(${actualIndex})">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('')}
        ` : '<p style="text-align: center; color: #666;">No unpaid invoices</p>'}
    </div>

    <!-- Paid Invoices -->
    <div class="card">
        <h2>Paid Invoices (${state.invoices.filter(i => i.status === 'Paid').length})</h2>
        
        ${state.invoices.filter(i => i.status === 'Paid').length > 0 ? `
            <div class="bulk-actions">
                <input type="checkbox" id="selectAll_paid_invoices" onchange="toggleSelectAllPaidInvoices()" class="checkbox-select">
                <label for="selectAll_paid_invoices">Select All</label>
                <span style="color: #666; font-size: 12px; margin-left: 8px;">
                    ${getSelectedPaidInvoiceCount()} selected
                </span>
                <button class="btn-small btn-danger" onclick="bulkDeletePaidInvoices()" ${!hasSelectedPaidInvoices() ? 'disabled' : ''}>
                    🗑️ Delete Selected
                </button>
            </div>
            
            ${state.invoices.filter(i => i.status === 'Paid').map((inv, origIdx) => {
                const actualIndex = state.invoices.findIndex(i => i === inv);
                return `
                <div class="item">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" class="checkbox-select" 
                               ${state.selectedItems.paid_invoices && state.selectedItems.paid_invoices[actualIndex] ? 'checked' : ''}
                               onchange="toggleSelectPaidInvoice(${actualIndex})">
                        <div style="flex: 1;">
                            <div class="item-header">
                                <span class="item-title">📄 ${inv.number}</span>
                                <span class="badge badge-success">Paid</span>
                            </div>
                            <div class="item-subtitle">
                                ${inv.customer}<br>
                                Paid: ${inv.date}<br>
                                <span style="font-weight: 700; color: #000;">Amount: 💰 ${formatNumber(inv.amount)} Tsh</span>
                            </div>
                            <div class="flex-gap" style="margin-top:8px;">
                                <button class="btn-small" onclick="downloadInvoicePDF(${actualIndex})">📥 Invoice PDF</button>
                                <button class="btn-small btn-danger" onclick="deleteInvoice(${actualIndex})">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('')}
        ` : '<p style="text-align: center; color: #666;">No paid invoices</p>'}
    </div>

    <!-- Receipts -->
    <div class="card">
        <h2>Receipts (${(state.receipts || []).length})</h2>
        
        ${(state.receipts && state.receipts.length > 0) ? `
            <div class="bulk-actions">
                <input type="checkbox" id="selectAll_receipts" onchange="toggleSelectAllReceipts()" class="checkbox-select">
                <label for="selectAll_receipts">Select All</label>
                <span style="color: #666; font-size: 12px; margin-left: 8px;">
                    ${getSelectedReceiptCount()} selected
                </span>
                <button class="btn-small btn-danger" onclick="bulkDeleteReceipts()" ${!hasSelectedReceipts() ? 'disabled' : ''}>
                    🗑️ Delete Selected
                </button>
            </div>
            
            ${(state.receipts || []).map((receipt, idx) => `
                <div class="item">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="checkbox" class="checkbox-select" 
                               ${state.selectedItems.receipts && state.selectedItems.receipts[idx] ? 'checked' : ''}
                               onchange="toggleSelectReceipt(${idx})">
                        <div style="flex: 1;">
                            <div class="item-header">
                                <span class="item-title">🧾 ${receipt.number}</span>
                                <span class="badge badge-success">Receipt</span>
                            </div>
                            <div class="item-subtitle">
                                ${receipt.customer}<br>
                                Date: ${receipt.date} ${receipt.time}<br>
                                <span style="font-weight: 700; color: #000;">Amount: 💰 ${formatNumber(receipt.amount)} Tsh</span>
                                ${receipt.linkedInvoice ? `<br>Linked to: ${receipt.linkedInvoice}` : ''}
                            </div>
                            <div class="flex-gap" style="margin-top:8px;">
                                <button class="btn-small" onclick="downloadReceiptPDF(${idx})">📥 Receipt PDF</button>
                                <button class="btn-small btn-danger" onclick="deleteReceipt(${idx})">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        ` : '<p style="text-align: center; color: #666;">No receipts yet</p>'}
    </div>
    `;
        }

        function toggleSelectAllUnpaidInvoices() {
            if (!state.selectedItems.unpaid_invoices) state.selectedItems.unpaid_invoices = {};

            const unpaidInvoices = state.invoices.filter(i => i.status !== 'Paid');

            // Check if all unpaid invoices are currently selected
            const allSelected = unpaidInvoices.every((inv) => {
                const idx = state.invoices.indexOf(inv);
                return state.selectedItems.unpaid_invoices[idx];
            });

            // Toggle: if all selected, unselect all; otherwise, select all
            const newState = !allSelected;

            unpaidInvoices.forEach(inv => {
                const idx = state.invoices.indexOf(inv);
                state.selectedItems.unpaid_invoices[idx] = newState;
            });

            saveData();
            render(); // RE-RENDER TO SHOW CHECKED ITEMS
        }

        function toggleSelectUnpaidInvoice(index) {
            if (!state.selectedItems.unpaid_invoices) state.selectedItems.unpaid_invoices = {};
            state.selectedItems.unpaid_invoices[index] = !state.selectedItems.unpaid_invoices[index];
            saveData();
            render(); // RE-RENDER TO UPDATE CHECKBOXES AND COUNT
        }

        function hasSelectedUnpaidInvoices() {
            return state.selectedItems.unpaid_invoices && Object.values(state.selectedItems.unpaid_invoices).some(v => v);
        }

        function getSelectedUnpaidInvoiceCount() {
            if (!state.selectedItems.unpaid_invoices) return 0;
            return Object.values(state.selectedItems.unpaid_invoices).filter(v => v).length;
        }

        function bulkMarkInvoicesPaid() {
            const selected = Object.keys(state.selectedItems.unpaid_invoices || {})
                .filter(i => state.selectedItems.unpaid_invoices[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No invoices selected', 'info');

            showConfirm(`Mark ${selected.length} invoices as paid?`, async function () {
                selected.forEach(i => {
                    if (state.invoices[i]) {
                        state.invoices[i].status = 'Paid';
                    }
                });

                state.selectedItems.unpaid_invoices = {};
                saveData();
                render();
                showToast(`${selected.length} invoices marked as paid`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        function bulkDeleteUnpaidInvoices() {
            const selected = Object.keys(state.selectedItems.unpaid_invoices || {})
                .filter(i => state.selectedItems.unpaid_invoices[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No invoices selected', 'info');

            showConfirm(`Delete ${selected.length} selected invoices?`, async function () {
                selected.sort((a, b) => b - a).forEach(i => {
                    state.invoices.splice(i, 1);
                });

                state.selectedItems.unpaid_invoices = {};
                saveData();
                render();
                showToast(`${selected.length} invoices deleted`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        function toggleSelectAllPaidInvoices() {
            if (!state.selectedItems.paid_invoices) state.selectedItems.paid_invoices = {};

            const paidInvoices = state.invoices.filter(i => i.status === 'Paid');

            // Check if all paid invoices are currently selected
            const allSelected = paidInvoices.every((inv) => {
                const idx = state.invoices.indexOf(inv);
                return state.selectedItems.paid_invoices[idx];
            });

            // Toggle: if all selected, unselect all; otherwise, select all
            const newState = !allSelected;

            paidInvoices.forEach(inv => {
                const idx = state.invoices.indexOf(inv);
                state.selectedItems.paid_invoices[idx] = newState;
            });

            saveData();
            render(); // RE-RENDER TO SHOW CHECKED ITEMS
        }

        function toggleSelectPaidInvoice(index) {
            if (!state.selectedItems.paid_invoices) state.selectedItems.paid_invoices = {};
            state.selectedItems.paid_invoices[index] = !state.selectedItems.paid_invoices[index];
            saveData();
            render(); // RE-RENDER TO UPDATE CHECKBOXES AND COUNT
        }

        function hasSelectedPaidInvoices() {
            return state.selectedItems.paid_invoices && Object.values(state.selectedItems.paid_invoices).some(v => v);
        }

        function getSelectedPaidInvoiceCount() {
            if (!state.selectedItems.paid_invoices) return 0;
            return Object.values(state.selectedItems.paid_invoices).filter(v => v).length;
        }

        function bulkDeletePaidInvoices() {
            const selected = Object.keys(state.selectedItems.paid_invoices || {})
                .filter(i => state.selectedItems.paid_invoices[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No invoices selected', 'info');

            showConfirm(`Delete ${selected.length} selected invoices?`, async function () {
                selected.sort((a, b) => b - a).forEach(i => {
                    state.invoices.splice(i, 1);
                });

                state.selectedItems.paid_invoices = {};
                saveData();
                render();
                showToast(`${selected.length} invoices deleted`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        function deleteInvoice(index) {
            showConfirm("Delete this invoice?", async function () {
                state.invoices.splice(index, 1);
                saveData();
                render();
                showToast("Invoice deleted", "success");

                if (syncEnabled) syncInBackground();
            });
        }

        function toggleInvoiceCustomerInput() {
            const select = document.getElementById('invoiceCustomer');
            const fields = document.getElementById('newInvoiceCustomerFields');
            if (select && fields) {
                if (select.value === 'new') {
                    fields.style.display = 'block';
                } else {
                    fields.style.display = 'none';
                }
            }
        }

        function switchInvoiceTab(tab) {
            state.activeInvoiceTab = tab;
            saveData();
            render();
        }

        function toggleReceiptCustomerInput() {
            const select = document.getElementById('receiptCustomer');
            const fields = document.getElementById('newReceiptCustomerFields');
            if (select && fields) {
                if (select.value === 'new') {
                    fields.style.display = 'block';
                } else {
                    fields.style.display = 'none';
                }
            }
        }

        function addInvoiceItem() {
            const container = document.getElementById('invoiceItemsList');
            const newRow = document.createElement('div');
            newRow.className = 'invoice-item-row';
            newRow.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
            newRow.innerHTML = `
        <input type="text" class="item-description" placeholder="Item description" style="flex: 2;" required>
        <input type="number" class="item-amount" placeholder="0.00" step="0.01" style="flex: 1;" required oninput="calculateInvoiceSubtotal()">
        <button type="button" class="btn-small btn-danger" onclick="removeInvoiceItem(this)" style="width: auto; padding: 8px 12px;">✕</button>
    `;
            container.appendChild(newRow);

            // Add event listener to first input too
            const firstAmount = container.querySelector('.item-amount');
            if (firstAmount && !firstAmount.hasAttribute('oninput')) {
                firstAmount.setAttribute('oninput', 'calculateInvoiceSubtotal()');
            }
        }

        function updateReceiptFromCustomer() {
            const select = document.getElementById('receiptCustomer');
            const manualField = document.getElementById('manualReceiptCustomerField');
            const invoiceGroup = document.getElementById('invoiceSelectionGroup');
            const invoiceSelect = document.getElementById('receiptInvoice');

            if (select.value === 'manual') {
                manualField.style.display = 'block';
                invoiceGroup.style.display = 'none';
                return;
            }

            manualField.style.display = 'none';

            if (select.value === '') {
                invoiceGroup.style.display = 'none';
                return;
            }

            const customer = state.customers[select.value];
            if (!customer) return;

            // Find invoices for this customer
            const customerInvoices = state.invoices.filter(inv =>
                inv.customer === customer.name && inv.status !== 'Paid'
            );

            if (customerInvoices.length > 0) {
                invoiceGroup.style.display = 'block';
                invoiceSelect.innerHTML = '<option value="">-- No Invoice --</option>' +
                    customerInvoices.map((inv, idx) => {
                        const actualIndex = state.invoices.indexOf(inv);
                        return `<option value="${actualIndex}">${inv.number} - ${formatNumber(inv.amount)} Tsh (Due: ${inv.dueDate})</option>`;
                    }).join('');

                // Auto-select first invoice
                if (customerInvoices.length === 1) {
                    invoiceSelect.selectedIndex = 1;
                    updateReceiptFromInvoice();
                }
            } else {
                invoiceGroup.style.display = 'none';
            }
        }

        function updateReceiptFromInvoice() {
            const invoiceSelect = document.getElementById('receiptInvoice');
            const descField = document.getElementById('receiptDescription');
            const amountField = document.getElementById('receiptAmount');

            if (!invoiceSelect.value) return;

            const invoice = state.invoices[invoiceSelect.value];
            if (!invoice) return;

            // Format items properly
            let itemsDescription = '';
            if (Array.isArray(invoice.items)) {
                itemsDescription = invoice.items.map(item =>
                    `${item.description} (${formatNumber(item.amount)} Tsh)`
                ).join(', ');
            } else {
                itemsDescription = String(invoice.items);
            }

            descField.value = `Payment for ${itemsDescription} (Invoice ${invoice.number})`;
            amountField.value = invoice.amount.toFixed(2);
        }

        function removeInvoiceItem(button) {
            const container = document.getElementById('invoiceItemsList');
            if (container.children.length > 1) {
                button.parentElement.remove();
                calculateInvoiceSubtotal();
            } else {
                showToast('At least one item is required', 'error');
            }
        }

        function calculateInvoiceSubtotal() {
            const amounts = document.querySelectorAll('.item-amount');
            let subtotal = 0;
            amounts.forEach(input => {
                const val = parseFloat(input.value) || 0;
                subtotal += val;
            });

            const subtotalField = document.getElementById('invoiceSubtotal');
            if (subtotalField) {
                subtotalField.value = formatNumber(subtotal) + ' Tsh';
            }

            // Update total with tax
            const taxRate = parseFloat(document.getElementById('invoiceTaxRate')?.value || 0) / 100;
            const tax = subtotal * taxRate;
            const total = subtotal + tax;

            // You can add a total display field if needed
        }

        async function createReceipt(e) {
            e.preventDefault();

            const customerSelect = document.getElementById('receiptCustomer').value;
            let customer;
            let customerName = '';
            let customerEmail = '';

            if (customerSelect === 'manual') {
                customerName = document.getElementById('manualReceiptCustomerName')?.value.trim();
                customerEmail = document.getElementById('manualReceiptCustomerEmail')?.value.trim();

                if (!customerName) return showToast('Please enter customer name', 'error');

                // Optionally add to customers list
                customer = {
                    id: generateID('customers'),
                    name: customerName,
                    email: customerEmail,
                    phone: '',
                    address: '',
                    totalPurchases: 0
                };
                // Don't auto-add manual entries to avoid clutter
                // state.customers.push(customer);
            } else {
                customer = state.customers[customerSelect];
                customerName = customer.name;
                customerEmail = customer.email || '';
            }

            const amount = parseFloat(document.getElementById('receiptAmount').value);
            if (isNaN(amount) || amount <= 0) {
                return showToast('Please enter a valid amount', 'error');
            }

            const now = new Date();
            const paymentMethod = document.getElementById('receiptPaymentMethod').value;
            const reference = document.getElementById('receiptReference')?.value.trim();

            // Check if linked to an invoice
            const invoiceSelect = document.getElementById('receiptInvoice');
            let linkedInvoice = null;
            if (invoiceSelect && invoiceSelect.value) {
                linkedInvoice = state.invoices[invoiceSelect.value];
                // Mark invoice as paid
                if (linkedInvoice) {
                    linkedInvoice.status = 'Paid';
                    showToast('Invoice marked as paid', 'success');
                }
            }

            const receipt = {
                id: generateID('receipts'),
                number: 'RCPT-' + Date.now().toString().slice(-6),
                customer: customerName,
                customerEmail: customerEmail,
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                description: document.getElementById('receiptDescription').value.trim(),
                amount: amount,
                paymentMethod: paymentMethod + (reference ? ' (Ref: ' + reference + ')' : ''),
                linkedInvoice: linkedInvoice ? linkedInvoice.number : null
            };

            if (!state.receipts) state.receipts = [];
            state.receipts.push(receipt);

            saveData();
            render();
            showToast("Receipt created successfully!", "success");

            if (syncEnabled) syncInBackground();
        }

        function downloadReceiptPDF(idx) {
            const receipt = state.receipts[idx];
            if (!receipt) return showToast("Receipt not found", "error");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: [226.77, 396.85] });
            const margin = 20;
            const centerX = 226.77 / 2;
            let y = 30;

            // Draw zigzag borders
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(1);
            const zigzagSize = 8;
            const zigzagCount = Math.floor(226.77 / zigzagSize);

            for (let i = 0; i < zigzagCount; i++) {
                const x1 = i * zigzagSize;
                const x2 = (i + 0.5) * zigzagSize;
                const x3 = (i + 1) * zigzagSize;
                if (i % 2 === 0) {
                    doc.line(x1, 10, x2, 5);
                    doc.line(x2, 5, x3, 10);
                } else {
                    doc.line(x1, 10, x2, 15);
                    doc.line(x2, 15, x3, 10);
                }
            }

            doc.line(10, 10, 10, 396.85 - 10);
            doc.line(226.77 - 10, 10, 226.77 - 10, 396.85 - 10);

            const profile = getUserProfileData();

            // Header
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(profile.businessName, centerX, y, { align: 'center' });
            y += 18;

            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            if (profile.address) {
                const addressLines = doc.splitTextToSize(profile.address, 186.77);
                addressLines.forEach(line => {
                    doc.text(line, centerX, y, { align: 'center' });
                    y += 10;
                });
            }
            if (profile.phone) {
                doc.text(`Tel: ${profile.phone}`, centerX, y, { align: 'center' });
                y += 10;
            }
            if (profile.email) {
                doc.text(`Email: ${profile.email}`, centerX, y, { align: 'center' });
                y += 10;
            }
            y += 8;

            doc.setLineWidth(0.5);
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Receipt Title
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('PAYMENT RECEIPT', centerX, y, { align: 'center' });
            y += 18;

            // Receipt Details
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(`Receipt No: ${receipt.number}`, margin, y);
            y += 11;
            doc.text(`Date: ${receipt.date}`, margin, y);
            y += 11;
            doc.text(`Time: ${receipt.time}`, margin, y);
            y += 16;

            doc.line(margin, y, 226.77 - margin, y);
            y += 13;

            // Received From
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.text('RECEIVED FROM', margin, y);
            y += 11;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(receipt.customer, margin, y);
            if (receipt.customerEmail) {
                y += 11;
                doc.setFontSize(7);
                doc.text(receipt.customerEmail, margin, y);
            }
            y += 16;

            // Description
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.text('DESCRIPTION', margin, y);
            y += 11;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            const descLines = doc.splitTextToSize(receipt.description, 186.77);
            descLines.forEach(line => {
                if (y > 320) return; // Prevent overflow
                doc.text(line, margin, y);
                y += 10;
            });
            y += 8;

            doc.line(margin, y, 226.77 - margin, y);
            y += 13;

            // Amount
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.text('AMOUNT PAID', margin, y);
            y += 14;
            doc.setFontSize(14);
            doc.text(`${formatNumber(receipt.amount)} Tsh`, centerX, y, { align: 'center' });
            y += 16;

            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            const paymentLines = doc.splitTextToSize(`Payment Method: ${receipt.paymentMethod}`, 186.77);
            paymentLines.forEach(line => {
                doc.text(line, centerX, y, { align: 'center' });
                y += 10;
            });
            y += 10;

            // Linked Invoice
            if (receipt.linkedInvoice) {
                doc.setFontSize(7);
                doc.text(`Related Invoice: ${receipt.linkedInvoice}`, centerX, y, { align: 'center' });
                y += 12;
            }

            doc.line(margin, y, 226.77 - margin, y);
            y += 13;

            // Footer
            doc.setFont(undefined, 'bold');
            doc.setFontSize(8);
            doc.text('The Ultimate Business Architecture - TUBA', centerX, y, { align: 'center' });
            y += 11;
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            doc.text(`© ${new Date().getFullYear()}`, centerX, y, { align: 'center' });


            // Bottom zigzag
            const bottomY = 396.85 - 10;
            for (let i = 0; i < zigzagCount; i++) {
                const x1 = i * zigzagSize;
                const x2 = (i + 0.5) * zigzagSize;
                const x3 = (i + 1) * zigzagSize;
                if (i % 2 === 0) {
                    doc.line(x1, bottomY, x2, bottomY + 5);
                    doc.line(x2, bottomY + 5, x3, bottomY);
                } else {
                    doc.line(x1, bottomY, x2, bottomY - 5);
                    doc.line(x2, bottomY - 5, x3, bottomY);
                }
            }

            doc.save(`${receipt.number}.pdf`);
            showToast("Receipt PDF downloaded", "success");
        }
        function deleteReceipt(idx) {
            showConfirm("Delete this receipt?", async function () {
                state.receipts.splice(idx, 1);
                saveData();
                render();
                showToast("Receipt deleted", "success");

                if (syncEnabled) syncInBackground();
            });
        }
        function toggleSelectAllReceipts() {
            if (!state.selectedItems.receipts) state.selectedItems.receipts = {};

            const receipts = state.receipts || [];

            // Check if all receipts are currently selected
            const allSelected = receipts.every((receipt, idx) => state.selectedItems.receipts[idx]);

            // Toggle: if all selected, unselect all; otherwise, select all
            const newState = !allSelected;

            receipts.forEach((receipt, idx) => {
                state.selectedItems.receipts[idx] = newState;
            });

            saveData();
            render(); // RE-RENDER TO SHOW CHECKED ITEMS
        }

        function toggleSelectReceipt(index) {
            if (!state.selectedItems.receipts) state.selectedItems.receipts = {};
            state.selectedItems.receipts[index] = !state.selectedItems.receipts[index];
            saveData();
            render(); // RE-RENDER TO UPDATE CHECKBOXES AND COUNT
        }

        function hasSelectedReceipts() {
            return state.selectedItems.receipts && Object.values(state.selectedItems.receipts).some(v => v);
        }

        function getSelectedReceiptCount() {
            if (!state.selectedItems.receipts) return 0;
            return Object.values(state.selectedItems.receipts).filter(v => v).length;
        }

        function bulkDeleteReceipts() {
            const selected = Object.keys(state.selectedItems.receipts || {})
                .filter(i => state.selectedItems.receipts[i])
                .map(i => parseInt(i));

            if (selected.length === 0) return showToast('No receipts selected', 'info');

            showConfirm(`Delete ${selected.length} selected receipts?`, async function () {
                selected.sort((a, b) => b - a).forEach(i => {
                    state.receipts.splice(i, 1);
                });

                state.selectedItems.receipts = {};
                saveData();
                render();
                showToast(`${selected.length} receipts deleted`, 'success');

                if (syncEnabled) syncInBackground();
            });
        }

        function toggleInvoiceStatus(idx) {
            const inv = state.invoices[idx];
            if (!inv) return;

            const statuses = ['Pending', 'Paid', 'Overdue'];
            const currentIdx = statuses.indexOf(inv.status);
            inv.status = statuses[(currentIdx + 1) % statuses.length];

            saveData();
            render();
            showToast(`Invoice status changed to ${inv.status}`, 'success');

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        async function createInvoice(e) {
            e.preventDefault();
            const customerSelect = document.getElementById('invoiceCustomer').value;
            let customer;

            if (customerSelect === 'new') {
                const newName = document.getElementById('newInvoiceCustomerName')?.value.trim();
                if (!newName) return showToast('Please enter customer name', 'error');
                const newPhone = document.getElementById('newInvoiceCustomerPhone')?.value.trim();
                const newEmail = document.getElementById('newInvoiceCustomerEmail')?.value.trim();

                // Check if customer already exists
                const existingCustomer = state.customers.find(c => c.name.toLowerCase() === newName.toLowerCase());

                if (existingCustomer) {
                    customer = existingCustomer;
                } else {
                    customer = {
                        id: generateID('customers'),
                        name: newName,
                        email: newEmail,
                        phone: newPhone,
                        address: '',
                        totalPurchases: 0
                    };
                    state.customers.push(customer);
                    showToast('New customer added to customers list', 'info');
                }
            } else {
                customer = state.customers[customerSelect];
            }

            // Collect all items
            const itemRows = document.querySelectorAll('.invoice-item-row');
            const items = [];
            let subtotal = 0;

            itemRows.forEach(row => {
                const desc = row.querySelector('.item-description').value.trim();
                const amount = parseFloat(row.querySelector('.item-amount').value) || 0;

                if (desc && amount > 0) {
                    items.push({ description: desc, amount: amount });
                    subtotal += amount;
                }
            });

            if (items.length === 0) {
                return showToast('Please add at least one item with an amount', 'error');
            }

            const taxRate = parseFloat(document.getElementById('invoiceTaxRate')?.value || 0) / 100;
            const taxAmount = subtotal * taxRate;
            const total = subtotal + taxAmount;

            const now = new Date();
            const invoice = {
                id: generateID('invoices'),
                number: 'INV-' + Date.now().toString().slice(-6),
                customer: customer.name,
                customerEmail: customer.email || '',
                customerAddress: customer.address || '',
                customerPhone: customer.phone || '',
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                dueDate: document.getElementById('invoiceDueDate').value,
                terms: document.getElementById('invoiceTerms')?.value.trim() || 'Due within 7 days',
                items: items,
                subtotal: subtotal,
                taxRate: taxRate * 100,
                taxAmount: taxAmount,
                amount: total,
                paymentMethod: document.getElementById('invoicePaymentMethod')?.value.trim() || 'Bank Transfer',
                notes: document.getElementById('invoiceNotes')?.value.trim() || '',
                status: 'Pending'
            };

            state.invoices.push(invoice);
            saveData();
            render();
            showToast("Invoice created successfully!", "success");

            if (syncEnabled) syncInBackground();
        }

        function downloadInvoicePDF(i) {
            const inv = state.invoices[i];
            if (!inv) return showToast("Invoice not found", "error");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const margin = 50;
            const usableWidth = pageWidth - margin * 2;
            let y = 50;

            const profile = getUserProfileData();

            // Header with gradient gray background
            doc.setFillColor(245, 245, 245);
            doc.rect(0, 0, pageWidth, 70, 'F');
            doc.setFillColor(230, 230, 230);
            doc.rect(0, 70, pageWidth, 70, 'F');

            // Company name
            doc.setTextColor(40, 40, 40);
            doc.setFontSize(26);
            doc.setFont(undefined, 'bold');
            doc.text(profile.businessName || 'Your Business Name', margin, 45);

            // Company details - show all profile info
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(80, 80, 80);
            let headerY = 70;

            if (profile.address) {
                doc.text(`Address: ${profile.address}`, margin, headerY);
                headerY += 14;
            }
            if (profile.phone) {
                doc.text(`Phone: ${profile.phone}`, margin, headerY);
                headerY += 14;
            }
            if (profile.email) {
                doc.text(`Email: ${profile.email}`, margin, headerY);
                headerY += 14;
            }

            // Add a subtle line separator
            doc.setDrawColor(150, 150, 150);
            doc.setLineWidth(2);
            doc.line(margin, headerY + 5, pageWidth - margin, headerY + 5);

            // Invoice details (right side)
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('INVOICE', pageWidth - margin, 45, { align: 'right' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`${inv.number}`, pageWidth - margin, 65, { align: 'right' });
            doc.text(`Date: ${inv.date}`, pageWidth - margin, 80, { align: 'right' });
            doc.text(`Due: ${inv.dueDate}`, pageWidth - margin, 95, { align: 'right' });

            y = 165;
            doc.setTextColor(0, 0, 0);

            // Bill To section
            doc.setFillColor(248, 248, 248);
            doc.roundedRect(margin, y, (usableWidth / 2) - 10, 100, 5, 5, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(107, 114, 128);
            doc.text('BILL TO', margin + 15, y + 20);

            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            doc.text(inv.customer, margin + 15, y + 40);

            let billY = y + 55;
            if (inv.customerEmail) {
                doc.setFontSize(9);
                doc.setTextColor(107, 114, 128);
                doc.text(inv.customerEmail, margin + 15, billY);
                billY += 12;
            }
            if (inv.customerPhone) {
                doc.text(inv.customerPhone, margin + 15, billY);
                billY += 12;
            }
            if (inv.customerAddress) {
                doc.text(inv.customerAddress, margin + 15, billY);
            }

            // Payment Terms section
            doc.setFillColor(248, 248, 248);
            doc.roundedRect(margin + (usableWidth / 2) + 10, y, (usableWidth / 2) - 10, 80, 5, 5, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(107, 114, 128);
            doc.text('PAYMENT TERMS', margin + (usableWidth / 2) + 25, y + 20);

            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(inv.terms || 'Due within 7 days', margin + (usableWidth / 2) + 25, y + 40);

            doc.setFont(undefined, 'bold');
            doc.text('Payment Method', margin + (usableWidth / 2) + 25, y + 60);
            doc.setFont(undefined, 'normal');
            doc.text(inv.paymentMethod || 'Bank Transfer', margin + (usableWidth / 2) + 25, y + 75);

            y += 120;

            // Items table
            doc.setFillColor(100, 100, 100);
            doc.rect(margin, y, usableWidth, 25, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('Item / Service', margin + 10, y + 16);
            doc.text('Amount', pageWidth - margin - 10, y + 16, { align: 'right' });

            y += 25;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);

            y += 25;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);

            // Parse items properly
            let items = [];
            if (Array.isArray(inv.items)) {
                items = inv.items;
            } else if (typeof inv.items === 'string') {
                try {
                    // Try to parse as JSON first
                    items = JSON.parse(inv.items);
                } catch (e) {
                    // If not JSON, split by comma
                    items = inv.items.split(',').map(s => ({ description: s.trim(), amount: 0 })).filter(i => i.description);
                }
            } else if (typeof inv.items === 'object') {
                items = [inv.items];
            }

            items.forEach((item, idx) => {
                if (idx % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin, y, usableWidth, 20, 'F');
                }

                const description = item.description || String(item);
                const amount = item.amount || 0;

                doc.text(description, margin + 10, y + 14);
                if (amount > 0) {
                    doc.text(`${formatNumber(amount)} Tsh`, pageWidth - margin - 10, y + 14, { align: 'right' });
                }
                y += 20;
            });

            y += 10;

            // Totals section
            const totalsX = pageWidth - margin - 150;

            if (inv.subtotal !== undefined) {
                doc.setDrawColor(200, 200, 200);
                doc.line(totalsX - 20, y, pageWidth - margin, y);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.text('Subtotal:', totalsX, y);
                doc.text(`${formatNumber(inv.subtotal)} Tsh`, pageWidth - margin, y, { align: 'right' });
                y += 18;

                if (inv.taxAmount && inv.taxAmount > 0) {
                    doc.text(`Tax (${inv.taxRate}%):`, totalsX, y);
                    doc.text(`${formatNumber(inv.taxAmount)} Tsh`, pageWidth - margin, y, { align: 'right' });
                    y += 18;
                }
            }

            doc.setDrawColor(100, 100, 100);
            doc.setLineWidth(2);
            doc.line(totalsX - 20, y, pageWidth - margin, y);
            y += 18;

            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('Total Due:', totalsX, y);
            doc.text(`${formatNumber(inv.amount)} Tsh`, pageWidth - margin, y, { align: 'right' });

            // Notes
            if (inv.notes) {
                y += 40;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(107, 114, 128);
                doc.text('Notes:', margin, y);
                y += 12;
                doc.setFont(undefined, 'normal');
                const noteLines = doc.splitTextToSize(inv.notes, usableWidth);
                noteLines.forEach(line => {
                    doc.text(line, margin, y);
                    y += 12;
                });
            }

            // Footer
            doc.setFillColor(80, 80, 80);
            doc.rect(0, 792 - 50, pageWidth, 50, 'F');
            doc.setFontSize(11);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('The Ultimate Business Architecture', pageWidth / 2, 792 - 28, { align: 'center' });
            doc.setFontSize(14);
            doc.text('- TUBA -', pageWidth / 2, 792 - 12, { align: 'center' });
            doc.save(`${inv.number}.pdf`);
            showToast("Invoice PDF downloaded", "success");
        }

        function downloadSaleReceiptPDF(timestamp) {
            const sale = state.sales.find(s => s.timestamp === timestamp);
            if (!sale) return showToast("Sale not found", "error");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: [226.77, 396.85] }); // 80mm x 140mm receipt size
            const margin = 20;
            const contentWidth = 226.77 - (margin * 2);
            let y = 30;

            // Draw zigzag top border
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(1);
            const zigzagSize = 8;
            const zigzagCount = Math.floor(226.77 / zigzagSize);

            // Top zigzag
            for (let i = 0; i < zigzagCount; i++) {
                const x1 = i * zigzagSize;
                const x2 = (i + 0.5) * zigzagSize;
                const x3 = (i + 1) * zigzagSize;
                if (i % 2 === 0) {
                    doc.line(x1, 10, x2, 5);
                    doc.line(x2, 5, x3, 10);
                } else {
                    doc.line(x1, 10, x2, 15);
                    doc.line(x2, 15, x3, 10);
                }
            }

            // Left border
            doc.line(10, 10, 10, 396.85 - 10);

            // Right border
            doc.line(226.77 - 10, 10, 226.77 - 10, 396.85 - 10);

            // Get profile data
            const profile = getUserProfileData();

            // Header - Business Name
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            const centerX = 226.77 / 2;
            doc.text(profile.businessName || 'Your Business', centerX, y, { align: 'center' });
            y += 20;

            // Business Info
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');

            if (profile.address) {
                const addressLines = doc.splitTextToSize(profile.address, 186.77);
                addressLines.forEach(line => {
                    doc.text(line, centerX, y, { align: 'center' });
                    y += 10;
                });
            }

            if (profile.phone) {
                doc.text(`Tel: ${profile.phone}`, centerX, y, { align: 'center' });
                y += 10;
            }

            if (profile.email) {
                doc.text(`Email: ${profile.email}`, centerX, y, { align: 'center' });
                y += 10;
            }

            // Separator line
            y += 8;
            doc.setLineWidth(0.5);
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Receipt Title
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('SALES RECEIPT', centerX, y, { align: 'center' });
            y += 18;

            // Date and Time
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(`Date: ${sale.date}`, margin, y);
            y += 12;
            doc.text(`Time: ${sale.time}`, margin, y);
            y += 12;
            doc.text(`Customer: ${sale.customer}`, margin, y);
            y += 18;

            // Separator line
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Item Details Header
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('ITEM/DESCRIPTION', margin, y);
            doc.text('QTY', 120, y);
            doc.text('PRICE', 160, y, { align: 'right' });
            y += 12;

            doc.setFont(undefined, 'normal');

            // Item Details
            doc.text(sale.productName, margin, y);
            y += 12;
            doc.text(`${sale.quantity}`, 120, y);
            doc.text(`${formatNumber(sale.pricePerUnit)}`, 160, y, { align: 'right' });
            y += 18;

            // Separator line
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Totals
            doc.setFontSize(9);
            doc.text('Subtotal:', margin, y);
            doc.text(`${formatNumber(sale.totalPrice)} Tsh`, 160, y, { align: 'right' });
            y += 15;

            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('TOTAL:', margin, y);
            doc.text(`${formatNumber(sale.totalPrice)} Tsh`, 160, y, { align: 'right' });
            y += 18;

            // Payment Method
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(`Payment: ${sale.payment}`, margin, y);
            y += 20;

            // Separator line
            doc.line(margin, y, 226.77 - margin, y);
            y += 15;

            // Footer
            doc.setFontSize(8);
            doc.text('Thank you for your business!', centerX, y, { align: 'center' });
            y += 12;
            doc.text('Visit us again', centerX, y, { align: 'center' });
            y += 18;

            // Transaction ID
            doc.setFontSize(7);
            doc.text(`Trans ID: ${sale.id || timestamp}`, centerX, y, { align: 'center' });

            // Bottom zigzag
            const bottomY = 396.85 - 10;
            for (let i = 0; i < zigzagCount; i++) {
                const x1 = i * zigzagSize;
                const x2 = (i + 0.5) * zigzagSize;
                const x3 = (i + 1) * zigzagSize;
                if (i % 2 === 0) {
                    doc.line(x1, bottomY, x2, bottomY + 5);
                    doc.line(x2, bottomY + 5, x3, bottomY);
                } else {
                    doc.line(x1, bottomY, x2, bottomY - 5);
                    doc.line(x2, bottomY - 5, x3, bottomY);
                }
            }

            // Save the PDF
            doc.save(`Receipt_${sale.id || timestamp}.pdf`);
            showToast("Receipt downloaded successfully!", "success");
        }

        function renderUnpaid() {
            const unpaidList = state.unpaidEntries.filter(e => !e.paid);
            const unpaidTotal = unpaidList.reduce((sum, e) => sum + (e.amount || 0), 0);

            return `
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">UNPAID ENTRIES</div>
                        <div class="stat-value">${unpaidList.length}</div>
                    </div>
                    <div class="stat-card" style="background: #d32f2f;">
                        <div class="stat-label">UNPAID AMOUNT</div>
                        <div class="stat-value">💱 ${formatNumber(unpaidTotal)} Tsh</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Add Unpaid Entry</h2>
                    <form onsubmit="addUnpaidEntry(event)">
                        <div class="form-group">
                            <label>Customer</label>
                            <select id="unpaidCustomer">
                                <option value="">-- Select Customer --</option>
                                ${state.customers.map((c, i) => `<option value="${i}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>OR Enter Customer Name</label>
                            <input type="text" id="unpaidName" placeholder="Enter name manually">
                        </div>
                        <div class="form-group">
                            <label>Product</label>
                            <select id="unpaidProduct" onchange="updateUnpaidAmount()">
                                <option value="">-- Select Product --</option>
                                ${state.products.map((p, i) => `<option value="${i}">${p.name} - 💱 ${formatNumber(p.price)} Tsh</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>OR Transaction Type</label>
                            <input type="text" id="unpaidType" placeholder="e.g., Product Sale">
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="unpaidAmount" placeholder="0.00" step="0.01" required>
                        </div>
                        <button type="submit">Add Unpaid Entry</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Unpaid Entries (${unpaidList.length})</h2>
                    
                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAll_unpaidEntries" onchange="toggleSelectAll('unpaidEntries')" class="checkbox-select">
                        <label for="selectAll_unpaidEntries">Select All</label>
                        <span style="color: #666; font-size: 12px; margin-left: 8px;">
                            ${getSelectedCount('unpaidEntries')} selected
                        </span>
                        <button class="btn-small btn-success" onclick="bulkMarkPaid()" ${!hasSelected('unpaidEntries') ? 'disabled' : ''}>
                            ✓ Mark Selected as Paid
                        </button>
                        <button class="btn-small btn-danger" onclick="bulkDelete('unpaidEntries')" ${!hasSelected('unpaidEntries') ? 'disabled' : ''}>
                            🗑️ Delete Selected
                        </button>
                    </div>

                    ${unpaidList.map((entry, idx) => `
                        <div class="item" style="border-left: 4px solid #d32f2f;">
                            <div style="display: flex; gap: 12px; align-items: start;">
                                <input type="checkbox" class="checkbox-select" 
                                       ${state.selectedItems.unpaidEntries && state.selectedItems.unpaidEntries[entry.id] ? 'checked' : ''}
                                       onchange="toggleSelect('unpaidEntries', '${entry.id}')">
                                <div style="flex: 1;">
                                    <div class="item-header">
                                        <span class="item-title">${entry.name}</span>
                                        <span class="badge badge-unpaid">UNPAID</span>
                                    </div>
                                    <div class="item-subtitle">
                                        ${entry.date} ${entry.time}<br>
                                        Type: ${entry.type}<br>
                                        Amount: <strong style="color: #d32f2f;">💰 ${formatNumber(entry.amount)} Tsh</strong>
                                    </div>
                                    <div class="flex-gap" style="margin-top:8px;">
                                        <button class="btn-success btn-small" onclick="markAsPaid(${entry.timestamp})">✓ Mark Paid</button>
                                        <button class="btn-small btn-danger" onclick="deleteUnpaidEntry(${entry.timestamp})">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('') || '<p style="text-align: center; color: #666;">No unpaid entries</p>'}
                </div>

                <div class="card">
                    <h2>Paid Entries (Last 10)</h2>
                    ${state.unpaidEntries.filter(e => e.paid).slice().reverse().slice(0, 10).map(entry => `
                        <div class="item">
                            <div class="item-header">
                                <span class="item-title">${entry.name}</span>
                                <span class="badge badge-paid">✓ PAID</span>
                            </div>
                            <div class="item-subtitle">
                                ${entry.date} ${entry.time}<br>
                                Type: ${entry.type}<br>
                                Amount: 💱 ${formatNumber(entry.amount)} Tsh
                            </div>
                        </div>
                    `).join('') || '<p style="text-align: center; color: #666;">No paid entries yet</p>'}
                </div>
            `;
        }

        function updateUnpaidAmount() {
            const productIndex = document.getElementById('unpaidProduct')?.value;
            if (productIndex !== null && productIndex !== '') {
                const product = state.products[productIndex];
                if (product) {
                    document.getElementById('unpaidAmount').value = product.price.toFixed(2);
                }
            }
        }

        async function addUnpaidEntry(e) {
            e.preventDefault();
            const now = new Date();
            state.unpaidEntries = state.unpaidEntries || [];

            const customerIndex = document.getElementById('unpaidCustomer')?.value;
            const manualName = document.getElementById('unpaidName')?.value.trim();
            let customerName = manualName;
            if (!customerName && customerIndex) {
                customerName = state.customers[customerIndex].name;
            }
            if (!customerName) {
                return showToast("Please select or enter customer name", "error");
            }

            const productIndex = document.getElementById('unpaidProduct')?.value;
            const manualType = document.getElementById('unpaidType')?.value.trim();
            let transactionType = manualType;
            if (!transactionType && productIndex !== null && productIndex !== '') {
                transactionType = state.products[productIndex].name;
            }
            if (!transactionType) {
                return showToast("Please select product or enter transaction type", "error");
            }

            const amount = parseFloat(document.getElementById('unpaidAmount').value);
            if (isNaN(amount) || amount <= 0) {
                return showToast("Please enter a valid amount", "error");
            }

            const entry = {
                name: customerName,
                type: transactionType,
                amount: amount,
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                paid: false
            };

            state.unpaidEntries.push(entry);
            saveData();
            render();
            showToast("Unpaid entry added", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function markAsPaid(timestamp) {
            const entry = state.unpaidEntries.find(e => e.timestamp === timestamp);
            if (!entry) return showToast("Entry not found", "error");

            entry.paid = true;
            const now = new Date();
            state.sales.push({
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime(),
                productName: entry.type,
                customer: entry.name,
                quantity: 1,
                costPerUnit: 0,
                pricePerUnit: entry.amount,
                totalCost: 0,
                totalPrice: entry.amount,
                profit: entry.amount,
                payment: 'Unpaid Entry - Now Paid'
            });

            // Update customer total
            const customer = state.customers.find(c => c.name === entry.name);
            if (customer) {
                customer.totalPurchases = (customer.totalPurchases || 0) + entry.amount;
            }

            saveData();
            render();
            showToast("Marked as paid and added to sales", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function deleteUnpaidEntry(timestamp) {
            showConfirm("Delete this unpaid entry?", function () {
                const idx = state.unpaidEntries.findIndex(e => e.timestamp === timestamp);
                if (idx !== -1) {
                    state.unpaidEntries.splice(idx, 1);
                    saveData();
                    render();
                    showToast("Entry deleted", "success");
                }
            });
        }

        function renderNotes() {
            return `
                <div class="card">
                    <h2>Add Note</h2>
                    <form onsubmit="addNote(event)">
                        <div class="form-group">
                            <label>Note Title (Optional)</label>
                            <input type="text" id="noteTitle" placeholder="Brief title...">
                        </div>
                        <div class="form-group">
                            <textarea id="noteContent" placeholder="Write your note here..." required></textarea>
                        </div>
                        <button type="submit">Save Note</button>
                    </form>
                </div>

                <div class="card">
                    <h2>All Notes (${state.notes.length})</h2>
                    <div class="search-box">
                        <input type="text" placeholder="🔍 Search notes..." oninput="searchNotes(this.value)" id="noteSearch">
                    </div>
                    <div id="notesList">
                        ${renderNotesList()}
                    </div>
                </div>
            `;
        }

        function renderNotesList(searchTerm = '') {
            let notes = state.notes.slice().reverse();

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                notes = notes.filter(n =>
                    n.content.toLowerCase().includes(term) ||
                    (n.title && n.title.toLowerCase().includes(term))
                );
            }

            if (notes.length === 0) {
                return '<p style="text-align: center; color: #666;">No notes found</p>';
            }

            return notes.map((note, idx) => {
                const actualIndex = state.notes.length - 1 - idx;
                const isEditing = state.editingNoteIndex === actualIndex;

                if (isEditing) {
                    return `
                <div class="item">
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Title (Optional)</label>
                        <input type="text" id="editNoteTitle_${actualIndex}" 
                               value="${(note.title || '').replace(/"/g, '&quot;')}" 
                               placeholder="Note title..."
                               style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Content</label>
                        <textarea id="editNoteContent_${actualIndex}" 
                                  style="width: 100%; min-height: 150px; padding: 10px; border: 2px solid #667eea; border-radius: 8px;"
                                  placeholder="Write your note here...">${note.content}</textarea>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-success btn-small" onclick="saveNoteEdit(${actualIndex})">💾 Save</button>
                        <button class="btn-secondary btn-small" onclick="cancelNoteEdit()">✖ Cancel</button>
                    </div>
                </div>
            `;
                }

                return `
            <div class="item">
                <div class="note-preview" onclick="openNoteModal(${actualIndex})" style="cursor: pointer;">
                    ${note.title ? `<div class="item-title" style="margin-bottom: 8px;">${note.title}</div>` : ''}
                    <div class="item-subtitle" style="margin-bottom: 8px;">${note.date} ${note.time}</div>
                    <div style="white-space: pre-wrap;">${note.content}</div>
                </div>
                <div style="display: flex; gap: 6px; margin-top: 8px;">
                    <button class="btn-small" onclick="startEditingNote(${actualIndex})">✏️ Edit</button>
                    <button class="btn-small btn-danger" onclick="deleteNoteByIndex(${actualIndex})">🗑️ Delete</button>
                </div>
            </div>
        `;
            }).join('');
        }

        function startEditingNote(index) {
            state.editingNoteIndex = index;
            saveData();
            render();
        }

        function cancelNoteEdit() {
            state.editingNoteIndex = null;
            saveData();
            render();
        }

        function saveNoteEdit(index) {
            const titleInput = document.getElementById(`editNoteTitle_${index}`);
            const contentInput = document.getElementById(`editNoteContent_${index}`);

            if (!contentInput || !contentInput.value.trim()) {
                return showToast('Note content cannot be empty', 'error');
            }

            state.notes[index].title = titleInput ? titleInput.value.trim() : '';
            state.notes[index].content = contentInput.value.trim();
            state.editingNoteIndex = null;

            saveData();
            render();
            showToast('Note updated successfully', 'success');

            if (syncEnabled) syncInBackground();
        }

        function searchNotes(term) {
            document.getElementById('notesList').innerHTML = renderNotesList(term);
        }

        async function addNote(e) {
            e.preventDefault();
            const now = new Date();
            const content = document.getElementById('noteContent').value.trim();
            const title = document.getElementById('noteTitle')?.value.trim();

            if (!content) {
                return showToast('Please enter note content', 'error');
            }

            const note = {
                title: title || '',
                content: content,
                date: getTodayDateString(),
                time: now.toLocaleTimeString(),
                timestamp: now.getTime()
            };

            state.notes.push(note);
            saveData();
            render();
            showToast("Note saved", "success");

            // Sync in background
            if (syncEnabled) syncInBackground();
        }

        function openNoteModal(index) {
            state.currentNoteIndex = index;
            const note = state.notes[index];
            const modal = document.getElementById('noteModal');
            const content = document.getElementById('noteModalContent');
            content.innerHTML = `
                ${note.title ? `<h3 style="margin-bottom: 12px; color: #1a1a1a;">${note.title}</h3>` : ''}
                <div style="margin-bottom: 12px; color: #666; font-size: 13px;">${note.date} ${note.time}</div>
                <div style="white-space: pre-wrap; line-height: 1.6;">${note.content}</div>
            `;
            modal.classList.add('show');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('show');
            state.currentNoteIndex = null;
        }

        function editNoteFromModal() {
            if (state.currentNoteIndex === null) return;
            const note = state.notes[state.currentNoteIndex];
            const newTitle = prompt("Edit title:", note.title);
            const newContent = prompt("Edit note:", note.content);
            if (newContent !== null && newContent.trim()) {
                if (newTitle !== null) note.title = newTitle.trim();
                note.content = newContent.trim();
                saveData();
                closeNoteModal();
                render();
                showToast("Note updated", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            }
        }

        function deleteNoteFromModal() {
            if (state.currentNoteIndex === null) return;
            showConfirm("Delete this note?", function () {
                state.notes.splice(state.currentNoteIndex, 1);
                saveData();
                closeNoteModal();
                render();
                showToast("Note deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }

        function deleteNoteFromModal() {
            if (state.currentNoteIndex === null) return;
            showConfirm("Delete this note?", function () {
                state.notes.splice(state.currentNoteIndex, 1);
                saveData();
                closeNoteModal();
                render();
                showToast("Note deleted", "success");

                // Sync in background
                if (syncEnabled) syncInBackground();
            });
        }


        function deleteNoteByIndex(index) {
            showConfirm("Delete this note?", function () {
                state.notes.splice(index, 1);
                saveData();
                render();
                showToast("Note deleted", "success");

                if (syncEnabled) syncInBackground();
            });
        }

        function togglePrivacy() {
            state.privacyBlurred = !state.privacyBlurred;
            saveData();
            render();
        }

        function renderAnalytics() {
            const stats = getStats();
            const netProfit = stats.netProfit;

            return `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
    <div class="stat-card" style="padding: 12px;">
        <div class="stat-label" style="font-size: 10px;">REVENUE</div>
        <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.totalRevenue)} Tsh</div>
    </div>
    <div class="stat-card" style="padding: 12px;">
        <div class="stat-label" style="font-size: 10px;">EXPENSES</div>
        <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(stats.totalExpenses)} Tsh</div>
    </div>
    <div class="stat-card" style="background: ${netProfit >= 0 ? '#2e7d32' : '#d32f2f'}; padding: 12px;">
        <div class="stat-label" style="font-size: 10px;">NET PROFIT</div>
        <div class="stat-value" style="font-size: 16px;">💰 ${formatNumber(netProfit)} Tsh</div>
    </div>
    <div class="stat-card" style="background: #1976d2; padding: 12px;">
        <div class="stat-label" style="font-size: 10px;">TOTAL SALES</div>
        <div class="stat-value" style="font-size: 16px;">${stats.totalSalesCount}</div>
    </div>
</div>

    <div class="card">
        <h2>Download Reports</h2>
        <button onclick="downloadDailyReportPDF()">📥 DAILY REPORT (PDF)</button>
        <button style="margin-top:8px;" onclick="downloadSalesReportPDF()">📥 Download Report (PDF)</button>
        <button class="btn-secondary" style="margin-top:8px;" onclick="downloadSalesReportExcel()">📥 Download Report (Excel)</button>
        <button class="btn-secondary" style="margin-top:8px;" onclick="downloadBackup()">💾 Backup All Data</button>
    </div>

    <div class="card">
        <h2>Payment Methods</h2>
        ${getPaymentMethodsHTML()}
    </div>

    <div class="card">
        <h2>Money Transactions Summary</h2>
        ${getTransactionSummaryHTML()}
    </div>

    <div class="card">
        <h2>Category Performance</h2>
        ${getCategoryPerformanceHTML()}
    </div>

    <div class="card">
        <h2>Top Products by Profit</h2>
        ${getTopProductsHTML()}
    </div>

    <div class="card">
        <h2>Analytics Chart</h2>
        <canvas id="analyticsChart"></canvas>
    </div>
`;
        }

        function getCategoryPerformanceHTML() {
            const categoryStats = {};
            state.sales.forEach(s => {
                const product = state.products.find(p => p.name === s.productName);
                if (product) {
                    if (!categoryStats[product.category]) {
                        categoryStats[product.category] = { profit: 0, revenue: 0, count: 0 };
                    }
                    categoryStats[product.category].profit += s.profit;
                    categoryStats[product.category].revenue += s.totalPrice;
                    categoryStats[product.category].count += 1;
                }
            });

            const entries = Object.entries(categoryStats).sort((a, b) => b[1].profit - a[1].profit);

            if (entries.length === 0) {
                return '<p style="text-align: center; color: #666;">No category data yet</p>';
            }

            return entries.map(([category, data]) => `
                <div class="item">
                    <div class="item-header">
                        <span class="item-title">${category}</span>
                        <span style="color: #2e7d32; font-weight: 700;">💱 ${formatNumber(data.profit)} Tsh</span>
                    </div>
                    <div class="item-subtitle">
                        Revenue: ${formatNumber(data.revenue)} Tsh | ${data.count} sales
                    </div>
                </div>
            `).join('');
        }

        function getTopProductsHTML() {
            const productStats = {};
            state.sales.forEach(s => {
                if (!productStats[s.productName]) {
                    productStats[s.productName] = { profit: 0, quantity: 0, revenue: 0 };
                }
                productStats[s.productName].profit += s.profit;
                productStats[s.productName].quantity += s.quantity;
                productStats[s.productName].revenue += s.totalPrice;
            });

            const entries = Object.entries(productStats).sort((a, b) => b[1].profit - a[1].profit).slice(0, 10);

            if (entries.length === 0) {
                return '<p style="text-align: center; color: #666;">No product data yet</p>';
            }

            return entries.map(([product, data], index) => `
                <div class="item">
                    <div class="item-header">
                        <span class="item-title">${index + 1}. ${product}</span>
                        <span style="color: #2e7d32; font-weight: 700;">💱 ${formatNumber(data.profit)} Tsh</span>
                    </div>
                    <div class="item-subtitle">
                        Sold: ${data.quantity} units | Revenue: ${formatNumber(data.revenue)} Tsh
                    </div>
                </div>
            `).join('');
        }

        function getPaymentMethodsHTML() {
            const paymentTotals = {};
            state.sales.forEach(s => {
                paymentTotals[s.payment] = (paymentTotals[s.payment] || 0) + s.totalPrice;
            });
            if (Object.keys(paymentTotals).length === 0) {
                return '<p style="text-align: center; color: #666;">No payment data yet</p>';
            }

            const entries = Object.entries(paymentTotals).sort((a, b) => b[1] - a[1]);
            return entries.map(([method, total]) => `
                <div class="item">
                    <div style="display: flex; justify-content: space-between;">
                        <span class="item-title">${method}</span>
                        <span style="font-weight: 700;">💱 ${formatNumber(total)} Tsh</span>
                    </div>
                </div>
            `).join('');
        }

        function getTransactionSummaryHTML() {
            const transactionTotals = {
                mpesa: { deposit: 0, withdrawal: 0 },
                crdb: { deposit: 0, withdrawal: 0 },
                nmb: { deposit: 0, withdrawal: 0 },
                airtel: { deposit: 0, withdrawal: 0 },
                halopesa: { deposit: 0, withdrawal: 0 },
                yas: { deposit: 0, withdrawal: 0 }
            };

            (state.transactions || []).forEach(t => {
                if (transactionTotals[t.channel]) {
                    transactionTotals[t.channel][t.type] += t.amount || 0;
                }
            });

            const channelLabels = {
                mpesa: 'M-Pesa',
                crdb: 'CRDB',
                nmb: 'NMB',
                airtel: 'Airtel Money',
                halopesa: 'Halopesa',
                yas: 'Yas Tanzania'
            };

            const channelColors = {
                mpesa: '#d32f2f',
                crdb: '#2e7d32',
                nmb: '#e65100',
                airtel: '#b71c1c',
                halopesa: '#fdd835',
                yas: '#0d47a1'
            };

            const hasTransactions = Object.values(transactionTotals).some(val => val.deposit > 0 || val.withdrawal > 0);

            if (!hasTransactions) {
                return '<p style="text-align: center; color: #666;">No transaction data yet</p>';
            }

            const entries = Object.entries(transactionTotals).filter(([channel, amounts]) =>
                amounts.deposit > 0 || amounts.withdrawal > 0
            );

            return entries.map(([channel, amounts]) => `
                <div class="item">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: ${channelColors[channel]};"></span>
                        <span class="item-title">${channelLabels[channel]}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; color: #666;">
                        <span>Deposits: <strong style="color: #2e7d32;">💱 ${formatNumber(amounts.deposit)} Tsh</strong></span>
                        <span>Withdrawals: <strong style="color: #d32f2f;">💱 ${formatNumber(amounts.withdrawal)} Tsh</strong></span>
                    </div>
                    <div style="margin-top: 4px; font-weight: 600;">
                        Net: <span style="color: ${amounts.deposit - amounts.withdrawal >= 0 ? '#2e7d32' : '#d32f2f'};">
                            ${amounts.deposit - amounts.withdrawal >= 0 ? '+' : ''}💱 ${formatNumber(amounts.deposit - amounts.withdrawal)} Tsh
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function createAnalyticsChart() {
            setTimeout(() => {
                const canvas = document.getElementById('analyticsChart');
                if (!canvas) return;

                if (chartInstance) {
                    chartInstance.destroy();
                }

                const stats = getStats();
                const revenue = stats.totalRevenue;
                const expenses = stats.totalExpenses;
                const profit = stats.totalProfit;

                const transactionTotals = {
                    mpesa: 0, crdb: 0, nmb: 0, airtel: 0, halopesa: 0, yas: 0
                };
                (state.transactions || []).forEach(t => {
                    if (transactionTotals.hasOwnProperty(t.channel)) {
                        transactionTotals[t.channel] += t.amount || 0;
                    }
                });

                const ctx = canvas.getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Revenue', 'Expenses', 'Profit', 'M-Pesa', 'CRDB', 'NMB', 'Airtel', 'Halopesa', 'Yas'],
                        datasets: [{
                            label: 'Amount (Tsh)',
                            data: [
                                revenue,
                                expenses,
                                profit,
                                transactionTotals.mpesa,
                                transactionTotals.crdb,
                                transactionTotals.nmb,
                                transactionTotals.airtel,
                                transactionTotals.halopesa,
                                transactionTotals.yas
                            ],
                            backgroundColor: [
                                '#1976d2',
                                '#d32f2f',
                                '#2e7d32',
                                '#d32f2f',
                                '#2e7d32',
                                '#e65100',
                                '#b71c1c',
                                '#fdd835',
                                '#0d47a1'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }, 100);
        }
        function downloadSalesReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const margin = 50;
            const usableWidth = pageWidth - margin * 2;
            let y = 50;

            // Header
            doc.setFillColor(26, 26, 26);
            doc.rect(0, 0, pageWidth, 100, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            const profile = getUserProfileData();
            doc.text(profile.businessName, margin, 45);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`${profile.address} | ${profile.phone} | ${profile.email}`, margin, 70);

            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(3);
            doc.line(margin, 85, pageWidth - margin, 85);

            y = 120;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Financial Report", margin, y);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${getTodayDateString()}`, margin, y + 20);
            y += 50;

            function drawTable(headers, rows, startY) {
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                let curY = startY;
                const rowHeight = 22;

                doc.setFillColor(102, 126, 234);
                doc.roundedRect(margin, curY, usableWidth, rowHeight, 3, 3, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                for (let i = 0; i < colCount; i++) {
                    const txtX = margin + i * colWidth + 8;
                    doc.text(String(headers[i]), txtX, curY + 15);
                }
                curY += rowHeight + 2;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                for (let r = 0; r < rows.length; r++) {
                    if (curY + rowHeight > 750) {
                        doc.addPage();
                        curY = margin;
                    }

                    if (r % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.roundedRect(margin, curY, usableWidth, rowHeight, 2, 2, 'F');
                    }

                    doc.setTextColor(40, 40, 40);
                    for (let c = 0; c < colCount; c++) {
                        const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                        const txtX = margin + c * colWidth + 8;
                        doc.text(txt, txtX, curY + 15, { maxWidth: colWidth - 16 });
                    }
                    curY += rowHeight;
                }
                return curY + 20;
            }

            // Sales
            const salesHeaders = ["Date", "Product", "Customer", "Qty", "Price", "Profit"];
            const salesRows = (state.sales || []).map(s => [
                s.date, s.productName, s.customer, s.quantity, formatNumber(s.totalPrice) + ' Tsh', formatNumber(s.profit) + ' Tsh'
            ]);
            if (salesRows.length > 0) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text("Sales Records", margin, y);
                y += 15;
                y = drawTable(salesHeaders, salesRows, y);
            }

            // Expenses
            const expHeaders = ["Date", "Description", "Category", "Amount"];
            const expRows = (state.expenses || []).map(e => [
                e.date, e.description, e.category, formatNumber(e.amount || 0) + ' Tsh'
            ]);
            if (expRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Expenses", margin, y);
                y += 15;
                y = drawTable(expHeaders, expRows, y);
            }

            // Transactions
            const transHeaders = ["Type", "Date", "Customer", "Amount"];
            const transRows = (state.transactions || []).map(t => [
                t.channel.toUpperCase(), t.date, t.customerName || 'N/A', formatNumber(t.amount || 0) + ' Tsh'
            ]);
            if (transRows.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Money Transactions", margin, y);
                y += 15;
                y = drawTable(transHeaders, transRows, y);
            }

            // Chart
            if (chartInstance) {
                doc.addPage();
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text("Analytics Overview", margin, 50);

                const chartImage = chartInstance.toBase64Image();
                doc.addImage(chartImage, 'PNG', margin, 70, usableWidth, 250);
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 792 - 30, pageWidth, 30, 'F');
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(9);
                doc.text(`Page ${i} of ${pageCount}`, margin, 792 - 11);
                doc.text(`The Ultimate Business Achitecture (TUBA) © ${new Date().getFullYear()}`, pageWidth - margin, 792 - 8, { align: 'right' });
            }

            doc.save(`Financial_Report_${getTodayDateString()}.pdf`);
            showToast("PDF downloaded successfully!", "success");
        }

        function downloadDailyReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = 595.28;
            const margin = 50;
            const usableWidth = pageWidth - margin * 2;
            let y = 50;

            const today = getTodayDateString();
            const todaySales = state.sales.filter(s => s.date === today);
            const todayExpenses = state.expenses.filter(e => e.date === today);
            const todayTransactions = state.transactions.filter(t => t.date === today);

            // Calculate today's stats
            const todayRevenue = todaySales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
            const todayProfit = todaySales.reduce((sum, s) => sum + (s.profit || 0), 0);
            const todayExpenseTotal = todayExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const todayNetProfit = todayProfit - todayExpenseTotal;

            // Header
            doc.setFillColor(26, 26, 26);
            doc.rect(0, 0, pageWidth, 100, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');

            const profile = getUserProfileData();
            doc.text(profile.businessName, margin, 45);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`${profile.address} | ${profile.phone} | ${profile.email}`, margin, 70);

            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(3);
            doc.line(margin, 85, pageWidth - margin, 85);

            y = 120;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Daily Report", margin, y);

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Date: ${today}`, margin, y + 20);
            y += 50;

            // Summary Box
            doc.setFillColor(240, 248, 255);
            doc.roundedRect(margin, y, usableWidth, 100, 5, 5, 'F');
            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(2);
            doc.roundedRect(margin, y, usableWidth, 100, 5, 5, 'S');

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text("TODAY'S SUMMARY", margin + 15, y + 20);

            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(`Total Sales: ${todaySales.length}`, margin + 15, y + 40);
            doc.text(`Revenue: ${formatNumber(todayRevenue)} Tsh`, margin + 15, y + 55);
            doc.text(`Profit: ${formatNumber(todayProfit)} Tsh`, margin + 15, y + 70);
            doc.text(`Expenses: ${formatNumber(todayExpenseTotal)} Tsh`, margin + 200, y + 40);
            doc.text(`Net Profit: ${formatNumber(todayNetProfit)} Tsh`, margin + 200, y + 55);

            const netColor = todayNetProfit >= 0 ? [46, 125, 50] : [211, 47, 47];
            doc.setTextColor(...netColor);
            doc.setFont(undefined, 'bold');
            doc.text(`Status: ${todayNetProfit >= 0 ? 'Profitable ✓' : 'Loss ✗'}`, margin + 200, y + 70);

            y += 120;

            function drawTable(headers, rows, startY) {
                const colCount = headers.length;
                const colWidth = usableWidth / colCount;
                let curY = startY;
                const rowHeight = 22;

                doc.setFillColor(102, 126, 234);
                doc.roundedRect(margin, curY, usableWidth, rowHeight, 3, 3, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                for (let i = 0; i < colCount; i++) {
                    const txtX = margin + i * colWidth + 8;
                    doc.text(String(headers[i]), txtX, curY + 15);
                }
                curY += rowHeight + 2;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                for (let r = 0; r < rows.length; r++) {
                    if (curY + rowHeight > 750) {
                        doc.addPage();
                        curY = margin;
                    }

                    if (r % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.roundedRect(margin, curY, usableWidth, rowHeight, 2, 2, 'F');
                    }

                    doc.setTextColor(40, 40, 40);
                    for (let c = 0; c < colCount; c++) {
                        const txt = rows[r][c] === null || rows[r][c] === undefined ? '' : String(rows[r][c]);
                        const txtX = margin + c * colWidth + 8;
                        doc.text(txt, txtX, curY + 15, { maxWidth: colWidth - 16 });
                    }
                    curY += rowHeight;
                }
                return curY + 20;
            }

            // Today's Sales
            if (todaySales.length > 0) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text("Today's Sales", margin, y);
                y += 15;
                const salesHeaders = ["Time", "Product", "Customer", "Qty", "Price", "Profit"];
                const salesRows = todaySales.map(s => [
                    s.time, s.productName, s.customer, s.quantity,
                    formatNumber(s.totalPrice) + ' Tsh', formatNumber(s.profit) + ' Tsh'
                ]);
                y = drawTable(salesHeaders, salesRows, y);
            }

            // Today's Expenses
            if (todayExpenses.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Today's Expenses", margin, y);
                y += 15;
                const expHeaders = ["Time", "Description", "Category", "Amount"];
                const expRows = todayExpenses.map(e => [
                    e.time, e.description, e.category, formatNumber(e.amount || 0) + ' Tsh'
                ]);
                y = drawTable(expHeaders, expRows, y);
            }

            // Today's Transactions
            if (todayTransactions.length > 0) {
                if (y > 650) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Today's Transactions", margin, y);
                y += 15;
                const transHeaders = ["Type", "Time", "Customer", "Amount"];
                const transRows = todayTransactions.map(t => [
                    t.channel.toUpperCase(), t.time, t.customerName || 'N/A',
                    formatNumber(t.amount || 0) + ' Tsh'
                ]);
                y = drawTable(transHeaders, transRows, y);
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 792 - 30, pageWidth, 30, 'F');
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(9);
                doc.text(`Page ${i} of ${pageCount}`, margin, 792 - 12);
                doc.text(`The Ultimate Business Achitecture (TUBA) © ${new Date().getFullYear()}`, pageWidth - margin, 792 - 8, { align: 'right' });
            }

            doc.save(`Daily_Report_${today}.pdf`);
            showToast("Daily report downloaded successfully!", "success");
        }

        function downloadSalesReportExcel() {
            const rows = [
                ["TUBA - The Ultimate Business Architecture"],
                ["Financial Report"],
                [`Generated: ${getTodayDateString()}`],
                [],
                ["SALES RECORDS"],
                ["Date", "Product", "Customer", "Quantity", "Price (Tsh)", "Profit (Tsh)"],
                ...((state.sales || []).map(s => [s.date, s.productName, s.customer, s.quantity, s.totalPrice, s.profit])),
                [],
                ["EXPENSES"],
                ["Date", "Description", "Category", "Amount (Tsh)"],
                ...((state.expenses || []).map(e => [e.date, e.description, e.category, e.amount])),
                [],
                ["MONEY TRANSACTIONS"],
                ["Type", "Date", "Customer", "Amount (Tsh)"],
                ...((state.transactions || []).map(t => [t.channel.toUpperCase(), t.date, t.customerName || 'N/A', t.amount]))
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);

            ws['!cols'] = [
                { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 15 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, "Financial Report");
            XLSX.writeFile(wb, `Financial_Report_${getTodayDateString()}.xlsx`);
            showToast("Excel downloaded successfully!", "success");
        }

        function downloadBackup() {
            exportData();
        }

        function exportData() {
            const data = {
                products: state.products,
                sales: state.sales,
                expenses: state.expenses,
                customers: state.customers,
                invoices: state.invoices,
                receipts: state.receipts || [],
                categories: state.categories,
                inventory: state.inventory,
                notes: state.notes,
                transactions: state.transactions,
                unpaidEntries: state.unpaidEntries,
                transactionFloats: state.transactionFloats,
                dailyTarget: state.dailyTarget,
                monthlyTarget: state.monthlyTarget,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TUBA_finance_backup_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm('This will replace all current data. Continue?')) {
                            state.products = data.products || [];
                            state.sales = data.sales || [];
                            state.expenses = data.expenses || [];
                            state.customers = data.customers || [];
                            state.invoices = data.invoices || [];
                            state.categories = data.categories || [];
                            state.inventory = data.inventory || {};
                            state.notes = data.notes || [];
                            state.transactions = data.transactions || [];
                            state.unpaidEntries = data.unpaidEntries || [];
                            state.transactionFloats = data.transactionFloats || state.transactionFloats;
                            state.dailyTarget = data.dailyTarget || 0;
                            state.monthlyTarget = data.monthlyTarget || 0;
                            calculateFloatBalances();
                            saveData();
                            render();
                            showToast('Data imported successfully!', 'success');
                        }
                    } catch (error) {
                        showToast('Error importing file. Please check the file format.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function updateHeaderDate() {
            const dateElement = document.getElementById('headerDate');
            if (!dateElement) return;

            const now = new Date();

            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');

            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // Convert 0 to 12

            dateElement.textContent = `${year}-${month}-${day} ${hours}:${minutes}:${seconds} ${ampm}`;
        }

        function render() {
            const app = document.getElementById('app');
            switch (state.activeTab) {
                case 'dashboard': app.innerHTML = renderDashboard(); break;
                case 'account': app.innerHTML = renderAccount(); break;
                case 'sales': app.innerHTML = renderSales(); break;
                case 'transactions': app.innerHTML = renderTransactions(); break;
                case 'products': app.innerHTML = renderProducts(); break;
                case 'categories': app.innerHTML = renderCategories(); break;
                case 'expenses': app.innerHTML = renderExpenses(); break;
                case 'inventory': app.innerHTML = renderInventory(); break;
                case 'customers': app.innerHTML = renderCustomers(); break;
                case 'invoices': app.innerHTML = renderInvoices(); break;
                case 'analytics':
                    app.innerHTML = renderAnalytics();
                    createAnalyticsChart();
                    break;
                case 'unpaid': app.innerHTML = renderUnpaid(); break;
                case 'notes': app.innerHTML = renderNotes(); break;
            }
            renderNav();

            // Update all "Select All" checkboxes after render
            setTimeout(() => {
                updateSelectAllCheckbox('sales');
                updateSelectAllCheckbox('products');
                updateSelectAllCheckbox('expenses');
                updateSelectAllCheckbox('customers');
                updateSelectAllCheckbox('transactions');
                updateSelectAllCheckbox('unpaidEntries');
            }, 0);
        }

        // Initialize
        initSupabase();
        updateHeaderDate();

        // Restore session and load data
        (async function () {
            const sessionRestored = await restoreSession();

            if (!sessionRestored) {
                // Not signed in - load local data
                console.log('📱 Loading local data...');
                loadData();
            } else {
                console.log('☁️ Session restored - data loaded from cloud');
            }

            render();
        })();

        // Update header date every second
        setInterval(() => {
            updateHeaderDate();
        }, 1000);

        // Auto-save every 15 seconds
        setInterval(() => {
            saveData();
        }, 15000);

        // PWA Manifest (find this section and replace it)
        const manifestData = {
            "name": "TUBA - The Ultimate Business Architecture",
            "short_name": "TUBA",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#000000",
            "theme_color": "#000000",
            "description": "Complete business management solution",
            "icons": [
                {
                    "src": "tuba-icon.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "tuba-icon.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
    </script>
</body>

</html>